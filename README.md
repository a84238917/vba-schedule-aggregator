# VBA Schedule Aggregator (工程表データ集約マクロ)

## 概要

このプロジェクトは、複数のExcel形式の月間工程表ファイルから指定されたデータを抽出し、指定されたExcelシートにデータベース形式で集約するVBAマクロです。
抽出ルール、対象ファイル、フィルター条件などは、マクロファイル内の「Config」シートで一元管理され、高い保守性と柔軟性を目指しています。

## 主な機能

*   **設定駆動:** 「Config」シートにより、VBAコードを修正することなく抽出ロジックの大部分を制御可能。
*   **複数ファイル/シート対応:** 複数の工程表ファイル、および各ファイル内の複数シートを処理対象にできます。
*   **工程パターン対応:** ファイルごと（または将来的にはシートごと）に異なるデータ構造（特に列構成）に対応可能な「工程パターン」機能を持ちます。
*   **柔軟なフィルター:** 作業員、管内、分類、工事種類、工番など、多岐にわたる項目でAND/OR、完全/部分一致検索を組み合わせたデータ絞り込みが可能です。
*   **自動生成シート:** 抽出結果シート、処理ログシート、エラーログシートは、存在しない場合にヘッダー付きで自動生成されます。
*   **詳細ログ出力:** 実行時の設定や処理ステップ、発生したエラーに関する詳細なログを出力し、トレーサビリティとデバッグの容易性を確保します。
*   **デバッグモード:** Config設定により、イミディエイトウィンドウへの詳細なデバッグ情報の出力を制御できます。

## プロジェクトの目的

*   手作業によるデータ集計作業の自動化と効率化。
*   人的ミスの削減とデータの一貫性向上。
*   将来的なフォーマット変更や抽出ルールの変更に柔軟に対応できる、保守性の高いツールの提供。

## フォルダ・ファイル構成

このリポジトリは以下の構成になっています。

```
vba-schedule-aggregator/
├── .gitignore                         # Gitの追跡から除外するファイルやフォルダを指定します。
├── README.md                          # このファイルです。プロジェクトの概要、セットアップ方法、使用方法などを記述します。
│
├── src/                               # VBAマクロのソースコード関連ファイルを格納します。
│   └── schedule_extractor.xlsm        # マクロ本体が含まれるExcelファイル。ユーザーはこのファイルを開いてマクロを実行します。
│
├── docs/                              # マクロの設計や仕様に関するドキュメントを格納します。
│   ├── 01_System_Instructions.md      # (AI向け)マクロ生成時の全体的な指示や開発原則。
│   ├── 02_Prompt_for_AI.md            # (AI向け)マクロ生成を依頼する際の具体的なプロンプト。
│   ├── 03_Specification.md            # マクロの機能仕様書。
│   ├── 04_Config_Sheet_Definition.md  # 「Config」シートの各設定項目の詳細な定義。
│   ├── 05_Expected_Behavior.md        # マクロに期待される具体的な動作フロー。
│   └── 06_Development_Considerations.md # (AI向け)その他考慮事項や開発上の補足情報。
│
└── samples/                           # マクロの使用例やテストに使用するサンプルデータ・ファイルを格納します。
    ├── config_examples/               # Configシートの設定例。
    │   └── config_sheet_example.xlsx  # 設定例が入力されたConfigシートを含むExcelファイル（またはCSV）。
    │
    ├── input_schedule_files/          # 処理対象となる工程表Excelファイルのサンプル。
    │   ├── schedule_pattern_A_example.xlsx # 工程パターンAのサンプル工程表。
    │   └── schedule_pattern_B_example.xlsx # 工程パターンBのサンプル工程表。
    │
    ├── output_examples/               # マクロによる抽出結果のサンプル。
    │   └── extracted_data_example.csv   # 「一覧」シートに出力されるデータのCSV形式サンプル。
    │
    └── work_sheet_examples/           # (もし使用する場合) Workシートのデータ構造とサンプル。
        └── work_sheet_data_example.csv

```

## セットアップ方法

1.  **リポジトリのクローンまたはダウンロード:**
    このリポジトリをローカル環境にクローンするか、ZIPファイルとしてダウンロードして展開します。
2.  **Excelファイルの準備:**
    `src/schedule_extractor.xlsm` ファイルを開きます。
3.  **マクロの有効化:**
    Excelのセキュリティ設定でマクロが有効になっていることを確認してください。通常、ファイルを開く際に「コンテンツの有効化」を求める警告が表示されます。
4.  **Configシートの設定:**
    `schedule_extractor.xlsm` ファイル内の「Config」シートを開き、処理対象の工程表ファイルパス、抽出条件、出力設定などを環境に合わせて設定します。詳細は `docs/04_Config_Sheet_Definition.md` を参照してください。

## 使用方法

1.  `src/schedule_extractor.xlsm` を開きます。
2.  「Config」シートに必要な設定を行います。
3.  (もしあれば)マクロ実行用のボタンをクリックするか、指定されたショートカットキーでマクロを実行します。
4.  処理が完了すると、メッセージボックスで結果（抽出件数、処理時間）が表示されます。
5.  「Config」シートで指定された「一覧」シートに抽出結果が出力されます。
6.  「処理ログ」シート、「エラー記録」シートに、それぞれ実行ログとエラーログが記録されます。

## 主な設定項目 (Configシート)

詳細は `docs/04_Config_Sheet_Definition.md` を参照してください。主要な設定項目は以下の通りです。

*   **デバッグモードフラグ:** イミディエイトウィンドウへの詳細ログ出力ON/OFF。
*   **各種シート名:** 出力シート、ログシートなどの名前。
*   **工程表ファイル情報:** 検索対象シート名、ヘッダー行数・列数、年月日の取得セルなど。
*   **工程パターン定義:** 各工程の管内情報、分類情報、シートごとの工程列数。
*   **フィルター条件:** 作業員、管内、分類、工事種類など、多岐にわたる絞り込み条件。
*   **処理対象ファイル指定:** 直接ファイル/フォルダパスを指定、または適用する工程パターン。
*   **抽出データオフセット:** 各抽出項目が工程表のどこにあるか。
*   **出力設定:** ヘッダー定義、データリセット/引継ぎオプション。

## 開発者向け情報

*   **VBAモジュール構成:**
    *   `M00_GlobalDeclarations`: グローバル定数・変数、ユーザー定義型。
    *   `M01_MainControl`: マクロ全体の実行制御。
    *   `M02_ConfigReader`: Configシートからの設定読み込み。
    *   `M03_SheetManager`: ワークシートの準備・管理。
    *   `M04_LogWriter`: ログ書き込み処理。
    *   `M05_FileProcessor`: 処理対象ファイルの特定。
    *   `M06_DataExtractor`: データ抽出・フィルター・書き込み。
    *   `(M_Utilities)`: (オプション) 汎用ヘルパー関数。
*   **コーディング規約:**
    *   `Option Explicit` を必須とします。
    *   変数は処理内容が分かる英語名（またはローマ字の日本語名詞）とします。
    *   詳細な日本語コメントを各処理ブロックに記述します。
    *   エラーハンドリングを適切に行い、堅牢性を高めます。
    *   レイトバインディングを基本とし、外部参照設定を極力不要にします。


## フォルダ名・ファイル名・ディレクトリ構成の提案 (修正版)

提示いただいた構成案は非常に良いので、それをベースに少しだけファイル名やフォルダ名を調整し、役割を明確化しました。特に `docs` フォルダ内のAI向けドキュメントに連番を振ることで、参照順序を示唆できるようにしています。

```
vba-schedule-aggregator/               # リポジトリルート
├── .gitignore                         # Gitで追跡しないファイルを指定 (例: *.~*, Thumbs.db, /~$*.xlsm)
├── README.md                          # プロジェクトの説明、セットアップ、使用方法、フォルダ構成解説など (上記提案内容)
│
├── src/                               # ソースコード (VBAマクロ本体)
│   └── schedule_extractor.xlsm        # マクロが含まれるExcelファイル (これがユーザーが使用するファイル)
│
├── docs/                              # ドキュメント類 (マクロの設計・仕様に関する資料)
│   ├── 00_Project_Overview.md         # (任意) プロジェクト全体の目的や背景を簡潔にまとめたもの
│   ├── 01_System_Instructions_for_AI.md # AIへの役割指示や開発原則
│   ├── 02_Prompt_for_AI.md            # AIにマクロ生成を依頼する際の具体的なプロンプト
│   ├── 03_Functional_Specification.md # マクロの機能仕様書
│   ├── 04_Config_Sheet_Definition.md  # 「Config」シートの各設定項目の詳細な定義と説明
│   ├── 05_Expected_Behavior.md        # マクロに期待される具体的な動作フロー、ステップバイステップの説明
│   └── 06_Development_Notes_and_Considerations.md # 開発上の注意点、AIへの補足事項、過去の課題など
│
└── samples/                                 # マクロのテストやデモンストレーションに使用するサンプルファイル群
    ├── examples_config_sheet/               # Configシートの設定例
    │   └── config_settings_example.csv      # 具体的な設定値が入力されたConfigシートをcsvへ変更したもの
    │
    ├── examples_work_sheet/                 # (Workシートを使用する場合) Workシートのデータ構造とサンプル
    │   └── work_sheet_sample_data.csv
    │
    ├── input_schedule_data_examples/                      # 具体的なデータが入った処理対象工程表のサンプル
    │   ├── monthly_schedule_202504_pA.xlsx                # 2025年4月、パターンAの工程表サンプルExcel
    │   ├── monthly_schedule_202504_pA_data.csv            # 2025年4月、パターンAの工程表サンプルcsvへ変更したもの
    │   └── monthly_schedule_202504_pA_data_screenshot.png # 2025年5月、パターンBの工程表サンプルスクリーンショット
    │
    └── output_data_examples/            # マクロによる抽出結果（「一覧」シートの内容）のサンプル
        └── extracted_data_sample.csv    # 抽出結果のCSV形式サンプル

```

**変更点と理由:**

*   **.gitignore:** 具体的な除外対象例を追記しました。
*   **README.md:** セットアップ方法、使用方法、開発者向け情報、貢献方法などを追加し、より一般的なOSSプロジェクトのREADMEに近づけました。
*   **`docs/` フォルダ:**
    *   ファイル名に連番とより説明的な英語名（`Functional_Specification`など）を付与し、ドキュメントの役割と参照順序を明確にしました。
    *   `development_notes.md` と `prompt.md` を、AI向けの指示書としてより包括的な名前に変更・統合するイメージです。
*   **`samples/` フォルダ:**
    *   `config_examples/`: Configシートの設定例を格納。Excel形式の方が実際のシート構造を伝えやすいかもしれません。
    *   `input_schedule_templates/`: ユーザーが新しい工程表ファイルを作成する際の**元となるテンプレート**や、マクロが処理すべき代表的な**フォーマットの骨格**を示すサンプルを格納。
    *   `input_schedule_data_examples/`: 実際に**データが入力された状態**の工程表ファイルサンプル。これにより、AIは具体的なデータ抽出のテストケースを想定しやすくなります。ファイル名にパターン情報を含めると分かりやすいです。
    *   `output_data_examples/`: 期待される出力結果のサンプル。
    *   `work_sheet_examples/`: `Work`シートの役割が明確になった際に使用します。

この構成とREADMEにより、プロジェクトの目的、使い方、そして開発の詳細がより明確になり、チームでの開発や将来のメンテナンスが容易になると思います。
