## このドキュメントの目的 (存在意義)

この「Functional Specification (機能仕様書)」ドキュメントは、**「VBA Schedule Aggregator (工程表データ集約マクロ)」が提供すべき全ての機能、および各機能が満たすべき具体的な要件を定義するもの**です。
これは、マクロが「何をするものなのか」「どのような能力を持つべきなのか」を明確にし、開発の範囲と目標を定めます。
この仕様書は、開発者（AIを含む）が実装すべき機能を正確に理解し、ユーザーの期待に応える製品を開発するための設計図として機能します。また、開発後のテストフェーズにおいて、マクロが仕様通りに動作するかを検証する際の基準ともなります。
このドキュメントを通じて、プロジェクト関係者全員がマクロの機能範囲について共通の理解を持つことを目指します。

---

**ドキュメントバージョン:** 1.1 (再構築版)
**最終更新日:** (AIが生成する日付)
**対象システム:** VBA Schedule Aggregator (工程表データ集約マクロ)

### 1. はじめに

#### 1.1. 文書目的
本文書は、月間工程表Excelファイルからデータを抽出し集約するVBAマクロ（以下、本マクロ）の機能要件を定義する。本マクロは、ユーザーが「Config」シートを通じて設定を変更することで、多様なデータ抽出ニーズに柔軟に対応できることを目指す。

#### 1.2. プロジェクト背景と目的
(「00_Project_Overview.md」の該当セクションを参照。ここでは簡潔に「手作業によるデータ集約の非効率性とエラーリスクを解消し、業務効率化とデータ品質向上を実現する」と記述する程度でも可)

#### 1.3. 用語定義
(「00_Project_Overview.md」の用語定義セクションを参照)

### 2. 機能概要
本マクロは、以下の主要機能を提供する。

*   **設定管理機能:** マクロの全動作を制御する設定情報を「Config」シートから読み込み、管理する。
*   **対象ファイル処理機能:** 指定された複数の工程表Excelファイルを処理対象として特定し、順次アクセスする。
*   **データ抽出機能:** 各工程表ファイルの指定されたシートから、定義されたルールに基づき関連データを抽出する。
*   **工程パターン適応機能:** 工程表の構造差異（特に列構成）に対応するため、ファイルごとに適用する「工程パターン」を切り替える。
*   **データフィルタリング機能:** 抽出されたデータに対し、ユーザーが定義した複数の条件に基づいて絞り込みを行う。
*   **データ出力機能:** フィルター処理後のデータを、指定された出力シートにデータベース形式で書き出す。
*   **ログ記録機能:** マクロの実行状況、適用された設定、発生したエラーなどを専用のログシートに記録する。
*   **デバッグ支援機能:** 詳細な処理情報をイミディエイトウィンドウに出力するデバッグモードを提供する。

### 3. 機能要件詳細

#### 3.1. 設定管理機能 (Configシート連携)
3.1.1. **設定ファイルの特定:** マクロ実行ファイル内に存在する、`CONFIG_SHEET_DEFAULT_NAME`定数で指定された名前のワークシート（デフォルト: "Config (2)"）を、本マクロの設定ファイルとして認識する。
    *   3.1.1.1. 当該シートが存在しない場合、エラーメッセージを表示し、エラーログに記録後、マクロを終了する。
3.1.2. **設定値の読み込み:** 「Configシート定義」ドキュメントに従い、指定されたセルから全ての動作設定値を読み込み、内部のグローバル設定構造体（例: `g_Config`）に格納する。
3.1.3. **設定値の検証:** 読み込んだ設定値に対し、以下の検証を行う。
    *   3.1.3.1. **必須項目の空欄チェック:** 「Configシート定義」で必須とされる項目が未入力の場合、エラーログに記録し、マクロの続行可否を判断する（続行不可ならエラーメッセージ表示後終了）。
    *   3.1.3.2. **データ型検証:** 数値、文字列、日付、セルアドレス形式など、各設定項目に期待されるデータ型との整合性を検証する。不整合の場合はエラーログに記録し、可能ならデフォルト値で補完（ログ記録）、不可能ならマクロ終了。
    *   3.1.3.3. **有効範囲検証:** 数値設定項目が指定された有効範囲（例: ヘッダー行数 0-10）内であるか検証する。範囲外の場合はエラーログに記録し、デフォルト値で補完またはマクロ終了。
3.1.4. **デバッグモード制御 (`Config O3`):**
    *   3.1.4.1. `Config`シート`O3`セルの値（`TRUE`/`FALSE`）に基づき、デバッグ情報のイミディエイトウィンドウへの出力有無を制御する。

#### 3.2. 対象ファイル処理機能
3.2.1. **処理対象ファイルの特定ロジック:**
    *   3.2.1.1. まず`Config`シート`P557`-`P756`「処理対象ファイル/フォルダパスリスト」を確認する。
    *   3.2.1.2. 上記リストに1つでも有効なパス（存在するファイルまたはフォルダ）が記載されていれば、それらを処理対象とする。
        *   フォルダパスの場合、そのフォルダ直下にあるExcelファイル（拡張子 `.xlsx`, `.xls`, `.xlsm`）のみをリストアップする（サブフォルダは探索しない）。
        *   無効なパス（存在しない、アクセス不可など）はエラーログに記録し、スキップする。
    *   3.2.1.3. 上記リストが全て空欄、または有効なパスが1つもなかった場合、ファイル選択ダイアログを表示する。
        *   ダイアログは複数ファイル選択を許可する。
        *   初期表示フォルダは`Config`シート`O12`「デフォルトフォルダパス」とする。
        *   ユーザーが「キャンセル」を選択した場合は、メッセージを表示しマクロを終了する。
    *   3.2.1.4. 最終的に処理対象ファイルが0件の場合、メッセージを表示しマクロを終了する。
3.2.2. **ファイルアクセスの基本動作:**
    *   3.2.2.1. 特定された各工程表ファイルを、**読み取り専用モード**で開く。
    *   3.2.2.2. ファイルオープン時にリンクの自動更新は行わない。
    *   3.2.2.3. **エラー処理:** ファイルが開けない（パスワード保護で失敗、ファイル破損、アクセス不可など）場合、エラーログにファイル名とエラー詳細を記録し、該当ファイルの処理をスキップして次のファイルの処理へ移行する。
    *   3.2.2.4. 1ファイルの処理完了後、そのファイルは保存せずに閉じる。

#### 3.3. データ抽出機能
3.3.1. **対象シート処理:**
    *   3.3.1.1. `Config`シート`O66`-`O75`「工程表内 検索対象シート名リスト」に記載されたシート名を順に処理する。
    *   3.3.1.2. **エラー処理:** 現在開いている工程表ファイル内に該当するシート名が存在しない場合、エラーログに記録し、そのシートの処理をスキップする。
3.3.2. **年月情報の取得:**
    *   3.3.2.1. 現在処理中のシートから、`Config`シート`O101`「「年」のセルアドレス」および`O102`「「月」のセルアドレス」で指定されたセルの値を取得し、年と月の情報を確定する。
    *   3.3.2.2. **エラー処理/データ検証:**
        *   指定セルが空、または数値として解釈できない場合、エラーログに記録する。
        *   取得した年または月が暦として無効な範囲（例: 月が0または13以上）の場合、エラーログに記録する。
        *   上記エラー時、もし前回正常に年月が取得できていれば、その値を流用し、ログに流用した旨を記録する。
        *   流用も不可能な場合（初回取得時など）は、当該シートの処理を中止し、エラーログに記録後、次のシート（またはファイル）の処理へ移行する。
3.3.3. **日次データブロックの処理:**
    *   3.3.3.1. 1日から`Config`シート`O90`「1シート内の最大日数」で指定された日数までループ処理を行う。
    *   3.3.3.2. 各「日」について、`Config`シート`O103`「「日」の値がある列文字」および`O104`「「日」の値の行オフセット」に基づき、日付セルから日の数値を取得する。
    *   3.3.3.3. **日付の確定と検証:**
        *   取得した日の数値と、3.3.2で確定した年月から、`DateSerial`関数等を用いて日付データ型を生成する。
        *   **エラー処理/データ検証:**
            *   日付セルが空、または数値として解釈できない場合、エラーログに記録する。
            *   生成された日付が無効な日付（例: 2月30日）の場合、エラーログに記録する。
            *   上記エラー時、もし同じシート内で前回正常に確定できた日付があれば、その日付を流用し、ログに流用した旨を記録する。
            *   流用も不可能な場合は、当該「日」の処理を中止し、エラーログに記録後、次の「日」の処理へ移行する。
3.3.4. **工程データブロックの処理（日次ループ内）:**
    *   3.3.4.1. 0から`Config`シート`O114`「1日の工程数」-1 までループ処理を行う。
    *   3.3.4.2. **基準セルの特定:** 各工程ブロックの基準となるセル位置（通常は左上セル）を計算する。最初の工程は`Config`の`O87`(ヘッダー行数)+1 行目、`O88`(ヘッダー列数)+1 列目。2番目以降の工程は、直前の工程が使用した列数（後述3.4.2で決定）を考慮して基準列を右にシフトする。
    *   3.3.4.3. **データ項目抽出:** 「Configシート定義」Fセクション「抽出データオフセット定義」（`N778`-`O792`）に基づき、各抽出項目名に対応するオフセット値（行,列）を使用して、基準セルからの相対位置にあるセルの値を取得する。
        *   抽出した値は一時的なデータ構造（配列など）に格納する。
        *   `Config`でオフセット指定が元々空白だった項目（`Is...OriginallyEmpty`フラグが`True`）は、抽出処理を行わず、対応するデータ構造の要素を空白とする。
        *   **作業員名の抽出:** 「作業員」項目のオフセットは作業員1を指す。作業員2以降は、その列オフセットを+1, +2...とインクリメントして順次抽出する。抽出する最大人数は10名までとし、かつ、現在適用中の工程パターンでその工程に割り当てられた「工程列数」（後述3.4.2.cで取得）を超えない範囲とする。
    *   3.3.4.4. **空白行判定:** 抽出したデータ（日付、管内1/2を除く主要項目）および全作業員名が全て空白文字列またはEmptyである場合、その工程データは処理対象外とし、次の工程へスキップする。

#### 3.4. 工程パターン適応機能
3.4.1. **適用パターンの決定と通知 (ファイルごと):**
    *   3.4.1.1. 現在処理中のファイルに対応する「適用工程パターン番号/文字列」（`Config`シート`Q列`から取得）を特定する。
    *   3.4.1.2. 特定したパターン識別子を`Config`シートの`O126`セルにVBAで書き込む。
3.4.2. **パターン依存データの取得 (ファイルごと、`O126`更新後):**
    *   3.4.2.1. `Config`シート`O122`「工程パターンデータ取得方法」フラグの値に応じて以下のいずれかの方法でデータを取得する。
        *   **`TRUE` (Excel数式再計算待ち):**
            a.  `Application.Calculate` を実行し、Excelブック全体の再計算を強制する。
            b.  Configシート上の数式（`J129:X列`など）が`Work`シートを参照して計算を完了するのを待つ（適切な待機処理を実装）。
            c.  再計算後、`Config`シートの`J129:N(128+O114の値)`から管内1/2、分類1/2/3の情報を、`O129:X(128+O114の値)`から各シート名（`O128:X128`ヘッダーと一致する列）に対応する工程列数の情報を読み取り、VBA内部のデータ構造に格納する。
        *   **`FALSE` (VBA直接参照):**
            a.  `O126`の値（または`Q列`から直接取得したパターン識別子）、`Config`シート`I列`の工程キーリスト、`Config`シート`O128:X128`のシート名ヘッダーをキーとして使用する。
            b.  VBAのロジック（`Find`メソッド、ループ検索など）を用いて、`Work`という名前のワークシートを直接検索・参照する。
            c.  `Work`シートから該当する管内1/2、分類1/2/3の情報、および各シート名に対応する工程列数の情報を取得し、VBA内部のデータ構造に格納する。
    *   3.4.2.2. **エラー処理:** 上記で必要なパターン情報（特に工程列数）が取得できない場合（例: `Work`シートに該当データなし、Configシートの数式がエラーを返すなど）、エラーログに記録し、デフォルトの工程パターン（例: パターン1の定義、または全工程列数1など、処理を継続できる最小限の定義）で処理を試みるか、あるいは当該ファイルの処理を中断する（仕様として明確化が必要な場合、AIは質問すること）。

#### 3.5. データフィルタリング機能
3.5.1. 3.3.4で抽出された1工程分のデータ（空白行判定を通過したもの）に対し、「Configシート定義」Dセクション「フィルター条件」で定義された全ての有効なフィルターを適用する。
3.5.2. **各フィルターの論理:**
    *   **作業員フィルター (`O242`-`O262`):** `O242`の値（`AND`または`OR`）に従い、`O243`-`O262`のリストと抽出作業員名を比較（完全一致、大文字小文字区別なし）。
    *   **その他のリスト形式フィルター**（管内1, 管内2, 分類1, 分類2, 分類3, 工事種類, 工番, 作業種類, 担当の名前, 作業箇所, 作業箇所の種類）: リスト内のいずれかの条件に合致すればOK（OR検索）。
        *   一致種別（完全/部分、大文字小文字区別）は「Configシート定義」の指示に従う。
        *   分類1/2/3のフィルターは、それぞれ`Config`シートの`L列`/`M列`/`N列`（129行目以降）から取得した分類データと比較する。
3.5.3. **単一項目フィルター**（人数 `O503`）: 指定された値と抽出データが完全一致するか比較。
3.5.4. **総合判定:** 抽出データが、有効化されている全てのフィルター条件を満たした場合のみ、次のデータ出力処理へ進む。一つでも条件に合致しない場合は、そのデータは破棄（出力しない）。

#### 3.6. データ出力機能
3.6.1. 3.5のフィルター処理を通過した1工程分のデータを、「Configシート定義」Gセクション「出力シート設定」に従い、「一覧」シート（`Config O43`で指定されたシート）に1行として書き出す。
3.6.2. **書き出し列順序:** 「一覧」シートのヘッダー（`Config O812`-`O821`で定義）に対応する順序でデータを書き込む。作業員名は最大10名分まで対応。
3.6.3. **日付フォーマット:** 日付データは "yyyy/mm/dd(aaa)" 形式の文字列として書き込む。
3.6.4. **書き込み行:** `outputNextRow` 変数（3.3.2で初期化/更新）が示す行に書き込み、書き込み後に`outputNextRow`をインクリメントする。

#### 3.7. ログ記録機能
3.7.1. **検索条件ログ (`Config O44`):**
    *   マクロ実行開始時に、実行日時、主要な`Config`設定値（処理対象ファイルパスの指定方法、フィルターの有効/無効や設定値など）を記録する。
3.7.2. **エラーログ (`Config O45`):**
    *   処理中に発生した全てのエラー（ファイルアクセスエラー、シートアクセスエラー、データ型不一致、日付変換エラー、計算エラー、予期せぬ実行時エラーなど）について、以下の情報を記録する。
        *   エラー発生日時
        *   エラーが発生したモジュール名およびプロシージャ名
        *   関連情報（例: 処理中のファイル名、シート名、セルアドレス、データ値）
        *   VBAエラー番号 (`Err.Number`)
        *   VBAエラーメッセージ (`Err.Description`)
        *   マクロが試みた対処（例: スキップ、デフォルト値使用、処理中断）
        *   （可能であれば）エラー発生直前の主要なローカル変数の値
3.7.3. **デバッグログ (イミディエイトウィンドウ):**
    *   `Config O3`「デバッグモードフラグ」が`TRUE`の場合、処理の主要ステップ（関数呼び出し、ループ開始/終了、ファイル/シートオープン、Config読み込み内容、フィルター判定詳細、抽出データ内容など）に関する詳細な情報をイミディエイトウィンドウに出力する。

#### 3.8. 終了処理
3.8.1. **Excelアプリケーション設定復元:** 3.1.2で変更したExcelの設定（画面更新、計算方法など）をマクロ実行前の状態に戻す。
3.8.2. **シート非表示処理:** `Config`シート`O1127`-`O1146`「マクロ実行後非表示シートリスト」に記載された名前のシートを、`O1126`「非表示方式」で指定された方法（`xlSheetHidden` または `xlSheetVeryHidden`）で非表示にする。ただし、出力シート自身は非表示にしない。
3.8.3. **出力シートのアクティブ化:** `Config`の`O43`で指定された出力シートをアクティブ表示する。
3.8.4. **完了通知:** ユーザーに対し、処理が完了した旨、総抽出件数、および総処理時間をメッセージボックスで表示する。
3.8.5. **オブジェクト解放:** 使用した全てのオブジェクト変数（Workbook, Worksheet, Collectionなど）を `Set ... = Nothing` で明示的に解放する。