---

## 仕様書: 工程表データ抽出マクロ Ver.Next (再構築版)

**Version:** 1.0
**作成日:** (AIが生成する日付)
**作成者:** (AIの名前/ID)

### 1. はじめに

#### 1.1. 目的
本マクロは、多様なフォーマットを持つ可能性のある月間工程表Excelファイル（複数存在しうる）から、ユーザーが「Config」シートで定義したルールに基づいて特定のデータを抽出し、マクロ実行ファイル内の指定された「一覧」シートにデータベース形式で一元的に集約することを目的とします。利用者がVBAの専門知識を持たなくても、設定変更を通じて柔軟に抽出条件を調整できる高い保守性と、エラー発生時にも可能な限り処理を継続する堅牢性を重視します。

#### 1.2. 対象読者
この仕様書は、本マクロの開発を担当するAI、および将来的に本マクロの保守や機能拡張を行う開発者を対象とします。

#### 1.3. 用語定義
*   **マクロ実行ファイル:** このVBAマクロが記述され、実行される `.xlsm` ファイル。
*   **Configシート:** マクロの全動作設定を定義する、マクロ実行ファイル内の "Config" という名前のワークシート。
*   **工程表ファイル:** データ抽出の対象となる、外部のExcelファイル（`.xlsx`, `.xls`, `.xlsm`）。
*   **工程パターン:** 工程表ファイルごとに異なるデータ構造（特に1日の工程ブロックの列数や関連情報）に対応するための定義セット。「Config」シートで管理される。
*   **抽出データ項目:** 工程表から取得する具体的な情報（例: 工番、作業場所、作業内容、担当者、人数、作業員名など）。
*   **オフセット:** 抽出データ項目が、工程ブロック内の基準セルから見てどの相対位置にあるかを示す「行数,列数」のペア。
*   **一覧シート:** 抽出され、フィルター処理されたデータが最終的に書き出される、マクロ実行ファイル内のワークシート。
*   **フィルターログシート:** マクロ実行時の主要な設定値や適用されたフィルター条件を記録するログ用ワークシート。
*   **エラーログシート:** マクロ処理中に発生したエラーの詳細情報を記録するログ用ワークシート。

### 2. システム概要

#### 2.1. マクロ構成
本マクロは、Microsoft Excel VBAで実装され、以下の主要な機能モジュールから構成されることを想定します（具体的なモジュール名、関数名はAIの裁量で可読性高く決定）。

*   **メイン制御モジュール:** マクロ全体の実行フローを管理し、各処理フェーズを統括する。
*   **Config読み込みモジュール:** 「Config」シートから全設定情報を読み込み、検証し、グローバルな設定データ構造に格納する。
*   **シート管理モジュール:** 出力シート、ログシート等の存在確認、必要に応じた自動生成（ヘッダー含む）、準備、およびマクロ終了時の表示制御を行う。
*   **ログ書き込みモジュール:** フィルターログおよびエラーログを指定されたシートに書き込む。
*   **ファイル処理モジュール:** 「Config」シートの指定またはファイルダイアログを通じて、処理対象となる工程表ファイルのリストを取得・管理する。
*   **データ抽出モジュール:** 個々の工程表ファイル・シートからデータを抽出し、フィルター条件を適用し、結果を出力シートに書き込む。

#### 2.2. データフローの概略
1.  マクロ起動。
2.  「Config」シートから全設定情報を読み込み。
3.  出力シート、ログシートを準備。
4.  処理対象の工程表ファイルリストを特定。
5.  各工程表ファイルに対してループ処理:
    a.  ファイルを開く。
    b.  適用する工程パターン情報を「Config」シートから（または`Work`シート経由で）取得。
    c.  ファイル内の対象シートに対してループ処理:
        i.  シートの年月情報を取得。
        ii. シート内の各日付に対してループ処理:
            1.  日付を確定。
            2.  各工程ブロックに対してループ処理:
                A.  データ項目を抽出。
                B.  空白行か判定。
                C.  フィルター条件と照合。
                D.  合致すれば「一覧」シートへ書き込み。
    d.  ファイルを閉じる。
6.  全ファイル処理後、終了処理（Excel設定復元、メッセージ表示、シート非表示など）。

### 3. 機能仕様詳細

#### 3.1. 初期化処理
1.  **グローバル設定の初期化:** マクロ全体で使用する設定情報格納用の構造体（例: `g_Config`）を初期状態にします。実行開始時刻、マクロファイル自身のパスなどを記録します。
2.  **Excelアプリケーション設定変更:** パフォーマンス向上のため、以下を設定します。
    *   画面更新停止 (`Application.ScreenUpdating = False`)
    *   計算方法手動 (`Application.Calculation = xlCalculationManual`)
    *   警告表示抑制 (`Application.DisplayAlerts = False`)
    *   イベント処理抑制 (`Application.EnableEvents = False`)

#### 3.2. Configシート読み込み (`Config`シート)
1.  **シート特定:** `CONFIG_SHEET_DEFAULT_NAME`定数で指定された名前（例: "Config (2)"）のシートをマクロ実行ファイル内から特定します。
    *   **エラー処理:** 見つからない場合は致命的エラーとしてログに記録し、ユーザーに通知してマクロを終了します。
2.  **全設定項目の読み込み:** 「Configシート定義」（別途提供されるMarkdown表を参照）に従い、指定されたセルから全ての値を読み取り、グローバル設定構造体に格納します。
    *   **デバッグモードフラグ (`O3`):** `TRUE`ならデバッグログをイミディエイトウィンドウに出力。
    *   **ファイルパス・シート名関連:** `O12`, `O43`-`O46`, `O66`-`O75`など。
    *   **工程表フォーマット基本値:** `O87`-`O114`。
    *   **工程パターン関連:**
        *   **`O122` (工程パターンデータ取得方法):** このフラグの値(`TRUE`/`FALSE`)により、後述の工程パターンデータの取得ロジックが分岐します。
        *   **`O126` (現在適用パターン番号):** マクロがファイルごとに`Q列`から読み取った値をここに転記します。
        *   **`I129`以降 (工程キー):** `O122`が`FALSE`の場合の`Work`シート検索キー。
        *   **`J129`以降～`N(128+工程数)` (管内1/2, 分類1/2/3):** `O122`が`TRUE`なら数式結果、`FALSE`ならマクロが`Work`から取得した結果。マクロはこの値を読み取ります。
        *   **`O128`-`X128` (工程列数定義用シート名ヘッダー):** 工程表内のシート名と突合します。
        *   **`O129`-`X(128+工程数)` (工程パターン別工程列数):** 対応するシートの各工程の列数を定義。
    *   **フィルター条件:** `O242`-`O544`。各フィルターリストは空白を無視し、配列として格納。文字列フィルターはカンマ区切りで複数条件指定可能なものは分割して配列化。
    *   **処理対象ファイル定義:** `P557`-`P756`（パス）、`Q557`-`Q756`（対応パターン）。
    *   **抽出データオフセット定義:** `N778`-`O792`。項目名とオフセット値(`行,列`)をペアで管理。
    *   **出力シート設定:** `O811`-`O821`, `O1124`, `O1126`-`O1146`。
3.  **設定値検証:** 読み込んだ値に対し、必須項目空欄チェック、データ型（数値、文字列、日付など）、有効範囲、書式（セルアドレス、オフセット）の検証を行います。
    *   **エラー処理:** 検証エラーがあった場合はエラーログに記録し、可能であればデフォルト値で補完（ログに記録）、不可能な場合は`errorOccurred`フラグを立てます。
4.  **読み込み完了判定:** `errorOccurred`フラグが立っていれば、ユーザーにエラーを通知しマクロを終了します。

#### 3.3. 処理シート準備
1.  **出力シート、ログシートの準備:**
    *   `Config`で指定された「抽出結果出力シート名」「検索条件ログシート名」「エラーログシート名」のシートが存在しなければ、ヘッダー付きで自動生成します。出力シートのヘッダーは`Config`の`O811`-`O821`の定義に従います。ログシートは固定の簡易ヘッダーで可。
    *   オプションシート（`Work`, `メニュー`, `リスト`）も`Config`で名前が指定されていれば存在確認・生成（ヘッダーなしで可）します。
    *   **エラー処理:** 必須シートの準備に失敗した場合は致命的エラーとしてマクロを終了。
2.  **出力シートの初期化/引継ぎ準備:**
    *   `Config`の`O1124`「出力データオプション」が "リセット" なら、出力シートの既存データ（ヘッダー除く）をクリア。
    *   "引継ぎ" なら、最終データの次の行を書き込み開始行とします。
    *   出力シートのオートフィルタは解除します。
3.  **グローバルログ変数の設定:** エラーログシートオブジェクトを`g_wsErrorLog`に、その次の書き込み行を`g_NextErrorLogRow`に設定します。

#### 3.4. 処理対象ファイルの特定
1.  **`Config`シート`P557`-`P756`「処理対象ファイル/フォルダパスリスト」を確認。**
    *   記載があれば、各パスを検証。フォルダなら直下のExcelファイル（拡張子`.xlsx`, `.xls`, `.xlsm`のみ）をリストアップ。ファイルなら直接リストに追加。無効なパスはログ記録してスキップ。
2.  上記リストが空の場合、**ファイル選択ダイアログ**を表示。
    *   複数選択可、Excelファイルフィルタ適用。初期フォルダは`Config`の`O12`。
    *   キャンセルされたらメッセージ表示後マクロ終了。
3.  最終的に処理対象ファイルが0件ならメッセージ表示後マクロ終了。
4.  取得した有効なファイルパスのリストと、それに対応する「適用工程パターン」（`Config`シート`Q557`-`Q756`から取得）をペアで内部的に保持します。

#### 3.5. 検索条件ログ出力
*   「検索条件ログシート」に、今回のマクロ実行日時、主要なフィルター設定（作業員、管内、分類など、実際に値が設定されているもの）、処理対象ファイル数などを記録します。

#### 3.6. データ抽出・処理（ファイルループ）
保持している「処理対象ファイルパス」と「対応する工程パターン」のペアリストを順に処理します。

1.  **ファイルオープン:** 対象ファイルを読み取り専用で開きます。
    *   **エラー処理:** 開けない場合はエラーログに記録し、そのファイルの処理を中断して次のファイルへ。
2.  **工程パターン適用準備:**
    a.  現在のファイルに対応する「適用工程パターン」（`Q列`の値）を`Config`シートの`O126`セルにVBAで書き込みます。
    b.  `Config`シート`O122`「工程パターンデータ取得方法」が`TRUE`の場合:
        i.  `Application.Calculate`を実行。
        ii. （必要に応じて）計算完了待機処理。
        iii. `Config`シートの`J129:N(128+工程数)`（管内/分類）と`O129:X(128+工程数)`（工程列数）の値を読み取り、VBA内部変数に格納します。
    c.  `Config`シート`O122`が`FALSE`（または`TRUE`以外）の場合:
        i.  `O126`（または`Q列`から直接読み取ったパターン）、`I列`の工程キー、`128行目`のシート名ヘッダーを使い、VBAロジックで`Work`シートを検索し、管内/分類情報と工程列数を取得して内部変数に格納します。
    d.  **エラー処理:** 上記で必要なパターン情報が取得できない場合、エラーログに記録し、デフォルトパターン（例：パターン1の定義）で処理を試みるか、このファイルの処理を中断します。
3.  **シート処理ループ:** `Config`シート`O66`-`O75`「検索対象シート名リスト」を処理します。
    a.  工程表ファイル内に対象シートが存在するか確認。
        *   **エラー処理:** 存在しない場合はエラーログに記録し、そのシートの処理をスキップ。
    b.  **年月取得:** `Config`の`O101`(年), `O102`(月)で指定されたセルから年月を取得。
        *   **エラー処理:** 取得失敗または不正値の場合、前回有効だった年月（`lastValidYear`, `lastValidMonth`）を流用（ログ記録）。流用も不可ならシート処理スキップ（ログ記録）。成功時は`lastValidYear`, `lastValidMonth`を更新。
    c.  **日処理ループ:** 1日から`Config`の`O90`「1シート内の最大日数」までループ。
        i.  **日付確定:** `Config`の`O103`(日列), `O104`(日オフセット)に基づき日付セル値を取得。
            *   **エラー処理/検証:** 値が空、非数値、1-31範囲外、または`DateSerial`で無効な日付（例:2/30）となる場合、前回有効だった日（`lastValidDateInSheet`）を流用（ログ記録）。流用も不可ならその日の処理スキップ（ログ記録）。成功時は`lastValidDateInSheet`更新。
        ii. **工程処理ループ:** 0から`Config`の`O114`「1日の工程数」-1までループ。
            1.  **基準セル特定:** 現在の工程ブロックの基準列を計算（前工程の使用列数を加算）。基準行は`dataBlockStartRow`。
            2.  **工程情報取得:** 現在の工程インデックスに対応する管内1/2、分類1/2/3の情報を、手順6.2で準備した内部変数から取得。
            3.  **工程列数取得:** 現在の工程表シート名と現在の工程インデックスに対応する「工程列数」を、手順6.2で準備した内部変数から取得。
            4.  **データ項目抽出:** `Config`の`O778`-`O792`で定義された各オフセットに基づき、基準セルからの相対位置にあるセルの値を抽出。
                *   作業員名は、上記3で取得した「工程列数」を上限とし、最大10名まで抽出。
                *   `Config`でオフセット定義が元々空欄だった項目（`Is...OriginallyEmpty`フラグが`True`）は抽出せず、空白とする。
            5.  **空白行判定:** 抽出データ（日付、管内除く主要項目と作業員）が全て空なら、この工程はスキップ。
            6.  **フィルター判定:** 抽出データを`Config`の`D`セクション「フィルター条件」と照合。
                *   作業員: `O242`の論理(`AND`/`OR`)、`O243`-`O262`リストと完全一致(大文字小文字無視)。
                *   管内1: `O275`-`O294`リストと完全一致(バイナリ)。OR検索。
                *   管内2: `O305`-`O334`リストと完全一致(バイナリ)。OR検索。
                *   分類1: `O346`リストと部分一致。OR検索。抽出元は`L列`対応データ。
                *   分類2: `O367`リストと部分一致。OR検索。抽出元は`M列`対応データ。
                *   分類3: `O388`リストと完全一致。OR検索。抽出元は`N列`対応データ。
                *   工事種類: `O409`-`O418`リストと部分一致。OR検索。
                *   工番: `O431`-`O440`リストと部分一致。OR検索。
                *   作業種類: `O451`-`O470`リストと作業名1or2のいずれかが部分一致。OR検索。
                *   担当の名前: `O481`-`O490`リストと部分一致。OR検索。
                *   人数: `O503`の値と完全一致(数値)。
                *   作業箇所: `O525`-`O544`リストと変電所名が部分一致。OR検索。
                *   作業箇所の種類: `O514`のリストと変電所名が部分一致。OR検索。
            7.  **データ書き出し:** 全フィルターに合致した場合、「一覧」シートの次の書き込み行に、定義された順序でデータを書き込む。日付は`yyyy/mm/dd(aaa)`形式。作業員名は最大10名分。
    d.  工程表ファイルを保存せずに閉じます。

#### 3.7. 終了処理
1.  **Excelアプリケーション設定復元:** `ScreenUpdating`等をマクロ実行前の状態に戻します。
2.  **シート非表示:** `Config`の`O1127`-`O1146`「非表示シートリスト」にあるシートを、`O1126`「非表示方式」で指定された方法で非表示にします（出力シートは除く）。
3.  **出力シートアクティブ化:** `Config`の`O43`「抽出結果出力シート名」のシートをアクティブにします。
4.  **完了メッセージ:** 抽出件数と処理時間をメッセージボックスで表示します。
5.  **オブジェクト解放:** 使用したオブジェクト変数を解放します。

### 4. デバッグとログ
*   **デバッグモード (`Config` `O3`):** `TRUE`の場合、イミディエイトウィンドウに詳細な処理ステップ、変数内容、Config読み込み結果、フィルター判定状況などを出力します。
*   **検索条件ログ (`Config` `O44`):** マクロ実行日時、適用された全フィルター条件の値、処理対象ファイル数、主要なConfig設定値などを記録します。
*   **エラーログ (`Config` `O45`):** 発生日時、モジュール/プロシージャ名、関連情報（ファイル/シート/セル）、エラー番号、エラーメッセージ、マクロが試みた対処（スキップ等）、（可能なら）関連変数値などを記録します。

### 5. その他要件
*   **パフォーマンス:** 大量データ処理を考慮し、極端に遅くならないよう配慮。ただし可読性・堅牢性優先。
*   **ユーザーインタフェース:** 基本的にConfigシートでの設定が主。処理中の進捗はステータスバーに表示推奨。
*   **コードコメント:** VBA初心者が理解しやすいよう、平易かつ詳細な日本語コメントを各所に記述。

---

この詳細仕様書が、AIによる高品質なコード生成の一助となることを願っています。
特に、`O122`フラグによる処理分岐と、それに伴う`Config`シートの動的な値の扱い（数式計算待ち or VBA直接読み取り）が、今回の再構築における重要なポイントとなります。
