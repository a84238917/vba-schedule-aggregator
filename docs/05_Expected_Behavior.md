
---

## 期待する動作（プログラムの挙動）書

### 1. マクロ実行開始時

1.  **初期化シーケンス:**
    a.  ユーザーがマクロ実行のトリガー（例：ボタンクリック、ショートカットキー）を操作します。
    b.  VBAはメイン制御プロシージャ（例: `ExtractDataMain`）の実行を開始します。
    c.  **グローバル設定構造体 (`g_Config`) の完全初期化:** `M00_GlobalDeclarations` で宣言された `g_Config` 変数の全メンバー（特に配列やオブジェクト型メンバー）を適切に初期化（例: 配列なら `Erase`、オブジェクトなら `Set ... = Nothing`）し、マクロ実行開始日時やマクロファイル自身のフルパスなどの基本情報を設定します。
    d.  **Excelアプリケーション設定の一時変更:**
        i.  `Application.ScreenUpdating = False` を実行し、処理中の画面描画を停止します。
        ii. `Application.Calculation = xlCalculationManual` を実行し、Excelの自動計算を手動に切り替えます。
        iii. `Application.DisplayAlerts = False` を実行し、Excel標準の警告ダイアログ表示を抑制します。
        iv. `Application.EnableEvents = False` を実行し、不要なイベント発生を抑制します。
    e.  処理開始時刻を `Timer` 関数などで記録します。

### 2. Configシートからの設定読み込み

1.  **`Config`シートの特定とオープン:**
    a.  `M00_GlobalDeclarations` で定義された `CONFIG_SHEET_DEFAULT_NAME`（例: "Config (2)"）を基に、マクロファイル内の該当シートオブジェクトを取得します。
    b.  **エラー処理:** `Config`シートが見つからない場合は、ユーザーにエラーメッセージを表示し、エラーログに「致命的エラー：Configシート不在」と記録し、マクロを安全に終了します（終了処理シーケンスへ移行）。
2.  **全設定項目の読み込みと検証:**
    a.  「Configシート定義」に基づき、指定された各セル（主にO列）から設定値を読み込み、`g_Config` 構造体の対応するメンバーに格納します。
    b.  **読み込み時の検証:**
        i.  **必須項目チェック:** 「Configシート定義」で必須とされている項目が空欄の場合、エラーログに記録し、`errorOccurred` フラグを立てます。
        ii. **データ型チェック:** 数値であるべき項目（例: `O87` ヘッダー行数）が数値に変換できない文字列の場合、エラーログに記録し、`errorOccurred` フラグを立てます（可能であればデフォルト値を使用し、ログにその旨を記録）。
        iii. **範囲チェック:** 特定の範囲内の数値であるべき項目（例: `O690` ヘッダー行数 1-10）が範囲外の場合、エラーログに記録し、`errorOccurred` フラグを立てます（可能であれば範囲内のデフォルト値を使用）。
        iv. **セルアドレス形式チェック:** セルアドレスが期待される形式（例: `FR2`）でない場合、エラーログに記録し、`errorOccurred` フラグを立てます。
        v.  **特定の文字列チェック:** 特定の選択肢（例: `O242` の `AND`/`OR`）が期待される文字列でない場合、エラーログに記録し、デフォルト値（例: `OR`）を使用します。
    c.  **動的リストの生成:**
        i.  検索対象シート名 (`O66`-`O75`)、各種フィルターリスト (`O243`-`O262`など)、処理対象ファイルパスリスト (`P557`-`P756`) などは、空白セルを無視して有効な値のみを動的配列に格納します。配列が空になる場合も考慮します。
        ii. 工程パターン列数定義 (`O129`-`X(128+工程数)`): `O114`「1日の工程数」分の行を、`O列`から最大10パターン（X列）まで読み込み、`g_Config.ProcessPatternColNumbers` に多次元配列または配列の配列として格納します。空白セルは0として扱います。
        iii. 工程詳細定義 (`I129`-`N(128+工程数)`): `O114`行数分の管内1、管内2、分類1、分類2、分類3の情報を読み込み、`g_Config.ProcessDetails` 配列（`tProcessDetail`型の配列、ただし分類情報も含むように拡張が必要か要検討）に格納します。空白は空白として格納。
    d.  **オフセット定義読み込み (`O778`-`O792`):** `N列`の項目名と`O列`のオフセット値(`行,列`)をペアで読み込み、`g_Config`内の対応する`tOffset`型メンバーに格納します。オフセット文字列が不正な場合はエラーログに記録。`Is...OriginallyEmpty` フラグも適切に設定します。
    e.  **`errorOccurred` フラグ確認:** 全ての項目読み込み後、このフラグが `True` であれば、ユーザーに「Configシートの設定にエラーがあります。詳細はエラーログを確認してください。」というメッセージを表示し、マクロを安全に終了します。

### 3. 処理シートの準備

1.  **必須シートの存在確認と自動生成:**
    a.  `g_Config.OutputSheetName`（一覧シート）、`g_Config.FilterLogSheetName`（検索条件ログ）、`g_Config.ErrorLogSheetName`（エラーログ）で指定された名前のシートがマクロファイル内に存在するか確認します。
    b.  存在しない場合は、それぞれのシートを新規作成します。
        i.  一覧シート: `g_Config.OutputHeaderRowCount` と `g_Config.OutputHeaderRows` に基づき、ヘッダー行を作成します。
        ii. ログシート: 実行に必要な最低限のヘッダー列（例: 日時, モジュール, 内容など）を1行目に作成します。
    c.  **エラー処理:** シートの作成・準備に失敗した場合は、エラーログに記録し、ユーザーにメッセージを表示してマクロを安全に終了します。
2.  **グローバルログ変数設定:** エラーログシートオブジェクトを `g_wsErrorLog` に、次の書き込み行を `g_NextErrorLogRow` に設定します。
3.  **出力シートの準備:**
    a.  `g_Config.OutputSheetName` で指定された出力シートオブジェクトを取得します。
    b.  `g_Config.OutputDataOption` の値（"リセット" or "引継ぎ"）に応じて処理します。
        i.  "リセット": 出力シートのヘッダー行より下の既存データを全てクリアします。書き込み開始行はヘッダーの次の行。
        ii. "引継ぎ": 出力シートのA列の最終データ行の次の行を書き込み開始行として取得します。もしシートが空かヘッダーのみの場合はヘッダーの次の行。
    c.  出力シートにオートフィルタがかかっていれば解除します。

### 4. 処理対象ファイルの特定

1.  **`Config`シートのパスリスト確認 (`P557`-`P756`):**
    a.  この範囲に有効なファイルパスまたはフォルダパスが1つでも記載されていれば、それらを処理対象とします。
    b.  フォルダパスが指定されている場合は、そのフォルダ直下にあるExcel拡張子（`.xlsx`, `.xls`, `.xlsm`）のファイルのみを対象とします（サブフォルダは探索しません）。
    c.  存在しないパスやファイルはエラーログに記録し、スキップします。
2.  **ファイル選択ダイアログの表示:**
    a.  上記1で有効な処理対象が1件も見つからなかった場合、ファイル選択ダイアログを表示します。
    b.  ダイアログのタイトルは「処理対象の工程表Excelファイルを選択してください」。複数選択を許可します。Excelファイルフィルタを設定します。
    c.  初期表示フォルダは `g_Config.DefaultFolderPath` を使用します。無効な場合はマクロファイルと同じフォルダ。
    d.  ユーザーがファイルを選択して「開く」をクリックした場合、選択されたファイルパスのリストを取得します。
    e.  ユーザーが「キャンセル」をクリックした場合、ユーザーにメッセージを表示し、マクロを安全に終了します。
3.  **最終対象リスト確認:** 上記1または2の結果、処理対象ファイルが0件の場合は、ユーザーにメッセージを表示し、マクロを安全に終了します。

### 5. 検索条件ログの出力

1.  `g_Config.FilterLogSheetName` で指定された検索条件ログシートに、今回のマクロ実行日時、`g_Config`から読み込んだ主要なフィルター設定値（作業員リスト、管内リスト、分類フィルター値など）、適用される工程パターンに関する情報などを記録します。

### 6. メイン処理ループ（ファイル単位）

取得された処理対象ファイルパスのリストを順番に処理します。各ファイルについて以下の処理を行います。

1.  **ファイルオープン:**
    a.  該当ファイルを**読み取り専用**で開きます。リンクの更新は行いません。
    b.  **エラー処理:** ファイルが開けない場合（パスワード保護で開けない、ファイル破損、アクセス権なし等）、エラーログにファイル名とエラー内容を記録し、このファイルの処理をスキップして次のファイルへ移ります。
2.  **工程パターン情報の決定と適用:**
    a.  現在処理中のファイルが、`P557`-`P756`リストの何番目か、またはファイルダイアログで選択された順番に基づき、対応する`Q557`-`Q756`の値（適用すべき工程パターン番号/文字列）を取得します。
    b.  取得したパターン情報を`Config`シートの`O126`セルにVBAで書き込みます。
    c.  `g_Config`の`O122`（工程パターンデータ取得方法フラグ）の値を確認します。
        i.  `TRUE`の場合: `Application.Calculate` を実行し、Configシート上の関連数式（`J129:X列`など）の再計算を促します。その後、数秒の待機処理を行うか、特定のキーセルが計算完了状態になるまで待機します。更新された`Config`シートの`J129:N(128+工程数)`（管内、分類）および`O129:X(128+工程数)`（工程列数）の値をVBAの内部変数（例：`activeProcessColCounts`や`currentProcessDetails`など）に読み込みます。
        ii. `FALSE`の場合: VBAロジック内で、`Work`シートを直接参照します。`O126`に設定（または`Q列`から直接取得）したパターン情報、`Config`シート`I列`の工程キーリスト、`Config`シート`128行目`のシート名ヘッダーをキーとして、`Work`シートから該当する管内情報、分類情報、および処理対象シート名ごとの工程列数を検索・取得し、VBAの内部変数に格納します。
    d.  **エラー処理:** 工程パターン情報が取得できない場合（例: `Work`シートに該当データなし）、エラーログに記録し、このファイルの処理をスキップするか、デフォルトのパターン（例: パターン1、全工程列数1など）で処理を試みます（Configで指定可能なら望ましい）。
3.  **シート処理ループ:** `g_Config.TargetSheetNames` 配列内の各シート名を順に処理します。
    a.  現在処理中の工程表ワークブック内で、該当する名前のシートオブジェクトを取得します。
    b.  **エラー処理:** シートが存在しない場合は、エラーログにファイル名、シート名を記録し、このシートの処理をスキップして次のシート名へ移ります。
    c.  **年月取得:**
        i.  `g_Config.YearCellAddress` および `g_Config.MonthCellAddress` で指定されたセルから年と月の情報を取得します。
        ii. **エラー処理:** セルが空、数値でない、または有効な年月範囲外の場合、まず`lastValidYear`/`lastValidMonth`（前回正常に取得できた年月）の流用を試みます。流用した場合はログに記録。流用も不可能な場合は、エラーログに記録し、このシートの処理をスキップして次のシート名へ。
        iii. 正常に取得/流用できた場合は、`lastValidYear`/`lastValidMonth` を更新します。
    d.  **日処理ループ:** 1日から `g_Config.DaysPerSheet` で指定された最大日数までループします。
        i.  **日付の確定:**
            1.  その日のデータブロックの開始行 (`dataBlockStartRow`) を計算します。
            2.  「日」の値があるセル (`dayCellActualRow`, `dayCellActualCol`) から日の数値を取得します。
            3.  **エラー処理/データ検証:**
                *   セルが空または数値でない場合: `lastValidDateInSheet`（このシートで前回有効だった日付）があれば流用し、ログに記録。なければ、エラーログに記録し、この日の処理をスキップ（`GoTo NextDay_LoopEnd_Label`など）。
                *   日の数値が1～31の範囲外の場合: 同様に流用またはスキップ。
                *   `DateSerial(年, 月, 日)` で日付オブジェクトを生成。エラー（例: 2月30日）が発生したら、同様に流用またはスキップ。
            4.  正常に日付が確定したら、`lastValidDateInSheet` を更新。
        ii. **工程処理ループ:** 0から `g_Config.ProcessesPerDay - 1` までループします。
            1.  現在の工程の基準列 (`currentProcessBaseCol`) を計算します（直前の工程が使用した列数を考慮）。
            2.  現在の工程に対応する管内1、管内2、分類1/2/3の情報を、手順6-c-iまたは6-c-iiで準備した内部変数から取得します。
            3.  現在の工程表シート名と、`Config`シート`C-8`のシート名ヘッダーを照合し、現在の工程に対応する「工程列数 (`currentProcessActualNumCols`)」を、準備した内部変数から取得します。
            4.  **データ抽出:** `Config`シート`F-2`で定義された各オフセットに基づき、`currentProcessBaseCol`と`dataBlockStartRow`を基準として、対応するデータを抽出し、一時的な配列 `extractedData` に格納します。
                *   作業員名は、`currentProcessActualNumCols` を上限とし、最大10名まで抽出します。
                *   `Config`でオフセットが元々空欄だった項目（例: `旧その他`）は、`extractedData` 内では空白とします。
            5.  **空白行判定:** `extractedData` 内の主要項目（日付、管内1/2を除く、工番、作業場所、作業内容、人数など）と、抽出された作業員名が全て空白かどうかを判定します。全て空白であれば、この工程のデータは無効とみなし、次の工程へスキップします。
            6.  **フィルター判定:** `extractedData` 配列の内容と、`g_Config` 内の各種フィルター設定（`D-1`～`D-14`）を照合します。
                *   各フィルター項目について、指定された検索論理（AND/OR）、一致種別（完全/部分）に従って判定します。
                *   全ての有効なフィルター条件（フィルターリストが空でないもの）に合致した場合のみ `isFilterMatched = True` とします。
            7.  **データ書き出し:** `isFilterMatched` が `True` の場合、
                A.  `totalExtractedCount` をインクリメントします。
                B.  `extractedData` 配列の内容を、出力シート（`wsOutput`）の `outputNextRow` 行目に書き込みます。日付は "yyyy/mm/dd(aaa)" 形式で。
                C.  `outputNextRow` をインクリメントします。
    e.  工程表ファイル（`wbKoutei`）を保存せずに閉じます。

### 7. 終了処理

1.  **Excelアプリケーション設定の復元:** `ScreenUpdating`, `Calculation`, `DisplayAlerts`, `EnableEvents` をマクロ実行前の状態（通常は `True`, `xlCalculationAutomatic`, `True`, `True`）に戻します。
2.  **シート非表示:** `g_Config.HideSheetNames` リストにあるシートを、`g_Config` の「非表示方式」(`O1126`) に従って非表示にします。ただし、出力シート自身は非表示にしません。
3.  **出力シートのアクティブ化:** `g_Config.OutputSheetName` で指定されたシートをアクティブにします。
4.  **完了メッセージ表示:** ユーザーに「処理が完了しました。抽出件数: X件、処理時間: Y.YY秒」というメッセージボックスを表示します。
5.  **オブジェクト解放:** 使用したワークブック、ワークシート、コレクションなどのオブジェクト変数を `Set ... = Nothing` で解放します。

---

この「期待する動作（プログラムの挙動）書」は、AIがマクロの各ステップを具体的にイメージし、適切なロジックとエラー処理を伴うコードを生成するためのガイドとなることを目的としています。
特に、`O122`フラグによる分岐処理や、配列のインデックス管理、エラー発生時のスキップロジックなどをAIが正確に理解することが重要です。
