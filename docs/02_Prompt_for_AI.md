## このドキュメントの目的 (存在意義)

この「Prompt for AI (AIへのプロンプト)」ドキュメントは、**「VBA Schedule Aggregator (工程表データ集約マクロ)」の完全なVBAコード生成を、AI開発者であるあなたに正式に依頼するための指示書**です。
このプロンプトは、あなたが参照すべき全ての関連ドキュメント（システム指示書、仕様書、Configシート定義、期待する動作など）を明示し、開発プロジェクトの背景、達成すべき主要目標、コード生成において特に重視すべき品質特性、そして具体的な実装上のキーポイントを改めて提示します。
このプロンプトを正確に理解し、関連ドキュメントと合わせて総合的に解釈することで、あなたはユーザーの要求仕様を完全に満たし、かつ高品質で保守性に優れたVBAマクロを生成することができるはずです。
これは、AIと人間の協調作業において、誤解を防ぎ、期待される成果物を効率的に得るための中心的なコミュニケーションツールとなります。

---

**依頼プロジェクト名:** VBA Schedule Aggregator (工程表データ集約マクロ) - 再構築

**依頼の背景と目的:**
既存のExcel VBAマクロ（工程表データ抽出用）には、保守性、堅牢性、およびユーザーによる設定変更の容易性において改善の余地がありました。この度、貴殿（AI開発者）には、別途提供する包括的なドキュメントセット（「System Instructions」「仕様書」「Configシート定義」「期待する動作（プログラムの挙動）書」「その他考慮事項・AIへの補足」）を唯一の設計根拠として、当該マクロを**ゼロから完全に再構築**していただくことを依頼します。以前のバージョンに存在したコードや実装の詳細は一切考慮せず、これらの最新ドキュメントに記述された要件と品質基準を完全に満たす、最高の品質を目指したVBAコードの生成をお願いします。

**あなたの主要タスク:**
提供された全ドキュメント群（特に以下のリストを参照）を精読・熟考し、その内容を完全に理解した上で、指定された全ての要件を満たすExcel VBAマクロの**完全なソースコード（全ての標準モジュールとその内部コード）**を生成してください。

**参照必須ドキュメントリスト:**
1.  `docs/01_System_Instructions_for_AI.md` (開発原則と品質基準)
2.  `docs/03_Functional_Specification.md` (機能仕様書)
3.  `docs/04_Config_Sheet_Definition.md` (Configシートの全項目定義)
4.  `docs/05_Expected_Behavior.md` (マクロの具体的な動作フロー)
5.  `docs/06_Development_Notes_and_Considerations.md` (開発上の補足と注意点)
6.  `docs/07_Naming_Conventions_and_Glossary.md` (命名規則と主要定義一覧)

**達成すべき最重要目標:**

*   **極めて高い保守性:** マクロの動作変更の大部分が「Config」シートの設定変更のみで完結し、VBAコードの直接的な修正が原則として不要となるアーキテクチャを実現してください。
*   **鉄壁の堅牢性:** ファイルやデータの不備、予期せぬユーザー操作など、あらゆる実運用上の問題に対処できる強固なエラーハンドリングを実装し、エラー発生時も可能な限り処理を継続し、その詳細な状況をログとして記録してください。
*   **究極の可読性:** VBAの専門知識が限定的なユーザー（将来のメンテナーを含む）でも、コードの各部分の処理の流れや意図が容易に理解できるよう、平易かつ詳細な日本語によるコメントと、一貫性のある明確な命名規則を徹底してください。

**コード生成における具体的かつ詳細な指示:**

1.  **ドキュメント群の絶対的遵守:**
    *   「**01_System_Instructions_for_AI.md**」に詳述されている**最重要開発原則**（設定駆動、可読性、堅牢性、デバッグ容易性、保守性、環境依存性低減、セル結合配慮、ユーザー定義型利用、禁止事項など）は、**開発プロセス全体を通じて遵守すべき絶対的なルール**と位置付けてください。
    *   「**04_Config_Sheet_Definition.md**」に定義されている「Config」シートの各セル範囲、項目名、設定例、およびその備考（関連動作など）を正確にVBAコードに反映させ、マクロがこれらの設定値を読み込んで動的に動作するように実装してください。特に以下のConfig項目とその処理ロジックの正確な実装は極めて重要です。
        *   `O3`: デバッグモードフラグのグローバルな適用。
        *   `O122`: 「工程パターンデータ取得方法」フラグに基づく、データ取得ロジックの明確な分岐（`TRUE`の場合はConfigシート上の数式再計算と結果読み取り、`FALSE`の場合はVBAによる`Work`シート直接参照）。
        *   `O126`: 「現在処理中ファイルに適用する工程パターン番号」セルへの、`Q列`からのパターン識別子の動的な転記処理。
        *   `Config`シートの`I列`から`X列`の129行目以降に定義される複雑な工程パターン詳細定義（管内情報、分類情報、シート名対応の工程列数）の正確な読み取りと利用。
        *   `N778`-`O792`で定義される「抽出データオフセット」の解釈と適用。
    *   「**03_Functional_Specification.md**」に記載された全ての機能要件、エラーハンドリング方針、ログ出力内容などを網羅的に実装してください。
    *   「**05_Expected_Behavior.md**」に記述された、マクロ起動から終了までのステップバイステップの処理フロー、条件分岐ロジック、ループ処理の詳細、ユーザーインタラクション（ダイアログ表示など）、エラー発生時の具体的な挙動を、VBAコードとして正確に具現化してください。

2.  **モジュール構成と設計:**
    *   「01_System_Instructions_for_AI.md」で例示されているモジュール分割案（`M00_GlobalDeclarations` から `M06_DataExtractor`、およびオプションの `M_Utilities`）を参考に、論理的で理解しやすく、かつ各モジュールの責務が明確に分離された構成としてください。
    *   **`M00_GlobalDeclarations` モジュールは必ず「標準モジュール」として作成し、プロジェクト全体で使用する全ての `Public Type` 宣言、グローバル定数（`Public Const`）、グローバル変数（`Public g_Config As tConfigSettings` など）は、このモジュールで一元的に宣言・管理してください。** これを怠ると深刻なコンパイルエラーが発生します。

3.  **変数名・関数名・プロシージャ名:**
    *   「01_System_Instructions_for_AI.md」および「07_Naming_Conventions_and_Glossary.md」に示された命名規則に従い、処理内容やデータの意味が明確に推測できる、具体的で分かりやすい**英語の単語または一般的に認知されているローマ字の日本語名詞**を使用してください。**具体的な命名はあなたの裁量に委ねますが、**この原則を強く意識し、プロジェクト全体で一貫性のある命名を行ってください。
    *   ローカル変数のスコープは、可能な限りその変数が必要とされる最小限の範囲（プロシージャレベルなど）に限定してください。

4.  **エラーハンドリングとログ出力の詳細実装:**
    *   「03_Functional_Specification.md」および「05_Expected_Behavior.md」で詳述されているエラーハンドリング方針（予期されるエラーのスキップ処理、詳細なエラーログ記録など）を徹底的に実装してください。
    *   エラーログシート、検索条件ログシートへの出力内容は、それぞれの仕様を満たすように、十分な情報量と明確なフォーマットで記録してください。
    *   デバッグモードフラグ (`Config O3`) が `TRUE` の場合にイミディエイトウィンドウに出力するデバッグ情報は、「01_System_Instructions_for_AI.md」で示された種類と詳細度を満たすようにしてください。

5.  **コメントの品質と量:**
    *   「01_System_Instructions_for_AI.md」で強く要求されている通り、**VBAの知識が浅い人がコードを読んでも、その処理の意図、流れ、各部分の役割が容易に理解できるレベルの、極めて詳細かつ平易な日本語コメント**を、モジュールヘッダ、プロシージャヘッダ、変数宣言ブロック、主要な処理ブロック、ループ処理、条件分岐の全てに対して記述してください。コメントはコードの品質を左右する重要な要素です。

6.  **特定の複雑なロジックの正確な実装:**
    *   **工程パターンデータ取得ロジック (`Config O122`による分岐):** この分岐処理はマクロの核心部分です。「期待する動作」で詳述された通り、`TRUE`の場合の「`O126`への書き込み -> `Application.Calculate` -> 適切な計算完了待機 -> Configシート上の数式結果読み取り」というフロー、および`FALSE`の場合の「`O126`の値（または`Q列`の値）、`I列`キー、`128行目`ヘッダーを使用したVBAによる`Work`シート直接検索・データ取得」というフローを、それぞれ正確かつ堅牢に実装してください。
    *   **ファイルごとの工程パターン適用ロジック:** 「処理対象ファイル定義」の`P列`（ファイルパス）と`Q列`（そのファイルに適用すべき工程パターン識別子）の対応関係を正しく管理し、各ファイル処理の開始時に、適切なパターン情報を上記6-aのロジックで`Config`シートの`O126`セルに適用（またはVBA内部で直接利用）してください。
    *   **抽出データオフセットの適用:** `Config`シート`N778`-`O792`の定義に基づき、各データ項目を正確に抽出してください。特に「作業員」のオフセットは作業員1を指し、作業員2以降は列オフセットをインクリメントするロジックを実装し、最大10名まで、かつ該当工程の「工程列数」（`Config`シート`C-9`で定義）を超えない範囲で抽出する処理を正確に実装してください。

7.  **禁止事項の厳格な遵守:**
    *   VBAコードの行途中でコロン (`:`) を使用して複数のステートメントを連結する記述は、一切禁止します。
    *   `If...Then` 構文において、`Then` の直後に改行せずに処理を記述する、いわゆる1行If文のスタイルは、一切禁止します。

**期待する最終成果物:**
全てのVBA標準モジュール（`M00`から`M06`、および必要に応じて作成したユーティリティモジュール）の完全なソースコード。各モジュールは、その冒頭にモジュール名と簡単な役割説明を含むコメントヘッダーを記述してください。

**最終確認のお願い:**
生成したVBAコード全体が、提供された全てのドキュメント（特に「04_Config_Sheet_Definition.md」と「05_Expected_Behavior.md」で定義された細かな仕様や挙動）と完全に整合性が取れているか、あなた自身で厳密にクロスチェックし、検証してください。

**質疑応答:**
もし、上記の指示内容や提供ドキュメント間に矛盾点や不明瞭な点を発見した場合、あるいは実装を進める上で技術的な課題やより良い代替案が予見される場合は、**コード生成に着手する前に、遠慮なく具体的な質問をしてください。** 明確な理解と合意の上で開発を進めることが、プロジェクトの成功に不可欠です。

このプロジェクトの再構築は、貴殿の卓越したVBA開発能力と、複雑な要求仕様を正確かつ高品質なコードへと変換する能力に大きく依存しています。ユーザーにとって真に価値があり、長期間にわたって安定して利用できる、模範的なマクロの完成を心より期待しています。