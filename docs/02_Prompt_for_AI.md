---

## プロンプト: Excel工程表データ抽出マクロ Ver.Next 再構築

**依頼の背景:**
既存のExcel VBAマクロ（工程表データ抽出用）において、保守性、堅牢性、およびユーザーによる設定変更の容易性に課題がありました。この度、提供する「System Instructions」「仕様書」「Configシート定義」「期待する動作（プログラムの挙動）書」に基づき、マクロを**完全に1から再構築**してください。以前のコードや実装の詳細は考慮せず、これらの最新ドキュメントを唯一の正として、最高の品質を目指したコードを生成してください。

**あなたのタスク:**
提供された全ドキュメントを熟読・理解した上で、以下の要件を満たすExcel VBAマクロの**完全なコード（全ての標準モジュールとその内容）**を生成してください。

**最重要目標:**
*   **極めて高い保守性:** 設定変更がConfigシートのみで完結し、VBAコードの修正が原則不要であること。
*   **鉄壁の堅牢性:** あらゆる予期せぬデータや状況に対処でき、エラー発生時も可能な限り処理を継続し、詳細なログを残すこと。
*   **究極の可読性:** VBA初心者が読んでも処理の流れや各コードの意図が容易に理解できるよう、平易な日本語による詳細なコメントと、明確な命名規則を徹底すること。

**コード生成における具体的指示:**

1.  **ドキュメントの厳守:**
    *   「**System Instructions**」に記載された開発原則（設定駆動、可読性、堅牢性、デバッグ容易性、保守性、環境依存性低減、セル結合配慮、ユーザー定義型利用、禁止事項）を**絶対的なルール**としてください。
    *   「**Configシート定義**」（Markdown表形式で提供済み）に記載された各セル範囲、項目名、設定例、備考を正確に反映し、マクロがこれらの設定値を読み込んで動作するようにしてください。特に以下の項目とその関連動作の理解が重要です。
        *   `O3`: デバッグモードフラグ
        *   `O122`: 工程パターンデータ取得方法（`TRUE`ならConfigシートの数式再計算待ち、`FALSE`ならVBAで`Work`シート直接参照）
        *   `O126`: 現在処理中ファイル適用パターン番号（マクロが`Q列`から値を転記）
        *   `I列`～`X列`の129行目以降: 工程パターン詳細定義（管内、分類、工程列数）の読み取り元
        *   `N778-O792`: 抽出データオフセット定義
    *   「**仕様書**」に記載された機能要件、エラーハンドリング方針、ログ出力内容などを全て満たすようにしてください。
    *   「**期待する動作（プログラムの挙動）書**」に記述されたステップバイステップの処理フロー、条件分岐、ループ処理、ユーザーインタラクション、エラー時の挙動を正確に実装してください。

2.  **モジュール構成:**
    *   「System Instructions」で例示されたモジュール分割（`M00_GlobalDeclarations`, `M01_MainControl`, `M02_ConfigReader`, `M03_SheetManager`, `M04_LogWriter`, `M05_FileProcessor`, `M06_DataExtractor`、およびオプションで`M_Utilities`）を参考に、論理的で理解しやすいモジュール構成としてください。各モジュールの責務を明確にしてください。
    *   **`M00_GlobalDeclarations` は必ず標準モジュールとし、全ての `Public Type` 宣言、グローバル定数、グローバル変数はここで一元管理してください。**

3.  **変数名・関数名:**
    *   「System Instructions」に従い、処理内容が推測できる具体的で分かりやすい**英語**（または一般的に認知されているローマ字の日本語名詞）を使用してください。**今回の指示では、AIに命名を委ねます**が、この原則を強く意識してください。
    *   ローカル変数のスコープは最小限にしてください。

4.  **エラーハンドリングとログ:**
    *   「仕様書」および「期待する動作」で詳述されているエラーハンドリング方針を徹底してください。予期されるエラーは可能な限りスキップ処理で継続し、詳細をエラーログシートに記録してください。
    *   エラーログ、検索条件ログの出力内容は、それぞれの仕様を満たすようにしてください。
    *   デバッグモードフラグ (`Config O3`) が `TRUE` の場合、イミディエイトウィンドウに詳細なデバッグ情報を出力してください（出力内容は「System Instructions」参照）。

5.  **コメント:**
    *   「System Instructions」で要求されている通り、**VBA初心者がコードの意図を理解できるレベルの、極めて詳細かつ平易な日本語コメント**を、モジュール、プロシージャ、変数宣言、主要な処理ブロック、ループ、条件分岐の全てに記述してください。

6.  **特定の複雑なロジックの実装:**
    *   **工程パターンデータ取得 (`Config O122`による分岐):**
        *   `TRUE`の場合: `O126`への書き込み -> `Application.Calculate` -> （適切な待機処理）-> `Config`シートの数式結果読み取り。
        *   `FALSE`の場合: `O126`の値（または`Q列`の値）、`I列`のキー、`128行目`ヘッダーを使い、VBAで`Work`シートを直接検索・データ取得。
    *   **ファイルごとの工程パターン適用:** 「処理対象ファイル定義」の`P列`（ファイルパス）と`Q列`（適用パターン）をペアで管理し、各ファイル処理時に対応するパターン情報を上記ロジックで`O126`に適用（または直接利用）してください。
    *   **抽出データオフセット:** `Config`シート`N778`-`O792`の定義に基づき、各項目を抽出してください。特に「作業員」のオフセットは作業員1を指し、作業員2以降は列オフセットをインクリメントし、最大10名まで、かつ該当工程の「工程列数」を超えない範囲で抽出してください。

7.  **禁止事項の遵守:**
    *   コード途中でのコロン (`:`) による処理連結の禁止。
    *   `If...Then` の1行記述の禁止。

**成果物:**
VBA標準モジュールに記述する、完全なマクロコード。各モジュールはコメントヘッダーで区切り、モジュール名を明記してください。

**最終確認:**
生成されたコードが、提供された全てのドキュメント（特に「Configシート定義」と「期待する動作」）と完全に整合性が取れているか、AI自身で厳密に確認してください。

**もし、上記の指示内容や提供ドキュメント間に矛盾がある、あるいは解釈に迷う点、実装上の技術的課題が予見される場合は、コード生成に着手する前に、具体的な質問をしてください。**

このプロジェクトの成功は、あなたの深いVBA知識と、ドキュメントを正確にコードへ変換する能力にかかっています。最高品質の成果を期待しています。
