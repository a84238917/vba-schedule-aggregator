## このドキュメントの目的 (存在意義)

この「Configシート定義」ドキュメントは、**「VBA Schedule Aggregator (工程表データ集約マクロ)」の全動作を制御する設定情報が、Excelワークシート「Config」上でどのように構成され、各設定項目がどのような意味を持つのかを詳細に記述したもの**です。
このマクロは「設定駆動 (Config-Driven)」を設計原則としており、ユーザーはVBAコードを直接編集することなく、この「Config」シート上の値を変更するだけで、マクロの挙動（処理対象ファイル、抽出ルール、フィルター条件、出力形式など）を広範囲にわたってカスタマイズできます。
したがって、このドキュメントは、開発者（AIを含む）がマクロの「設定読み込み処理」を正確に実装し、各設定値が意図した通りにマクロの動作に反映されるようにするための、不可欠なリファレンスとなります。また、エンドユーザーがマクロの設定を行う際の公式なガイドとしても機能します。
この定義書を通じて、Configシートの各項目とその役割、設定可能な値、そしてそれがマクロの挙動にどう影響するかの共通理解を確立します。

---

**シート名: `Config`**

**凡例:**
*   **代表セル範囲:** 設定項目が配置されている主要なセルまたはセル範囲。
*   **項目名:** 設定項目の分かりやすい名称。
*   **設定例 / 詳細説明 / 関連動作・備考:**
    *   **設定例:** 具体的にどのような値を入力するかを示します。
    *   **詳細説明:** その設定項目が何を意味し、マクロのどの部分に影響を与えるかを説明します。
    *   **関連動作・備考:** その設定に関連するマクロの具体的な動作や、設定時の注意点、他の設定項目との関連などを記述します。

---

| 代表セル範囲                 | 項目名                                                                 | 設定例 / 詳細説明 / 関連動作・備考                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| :--------------------------- | :--------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **A. 全般設定**             |                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| `O3`                         | **A-1. デバッグモードフラグ**                                              | **設定例:** `TRUE` または `FALSE` (文字列、大文字小文字区別なし)。<br>**詳細説明:** マクロ実行中に詳細なデバッグ情報をイミディエイトウィンドウに出力するかどうかを制御します。<br>**関連動作:** `TRUE`の場合、処理の各ステップ、主要な変数値、エラー発生時の状況などがイミディエイトウィンドウに出力されます。`FALSE`の場合は出力が抑制され、通常運用モードとなります。<br>**備考:** 開発時やトラブルシューティング時には`TRUE`に設定し、通常運用時は`FALSE`にすることを推奨します。                                                                                                                                                                                                                                                                         |
| `O12`                        | **A-2. デフォルトフォルダパス**                                            | **設定例:** `C:\Users\YourName\Documents\工程表データ` など、存在する有効なフォルダパス (文字列)。<br>**詳細説明:** 「E-2. 処理対象ファイル/フォルダパスリスト」(`P557`-`P756`)が全て空欄の場合に表示される、ファイル選択ダイアログの初期表示フォルダを指定します。<br>**関連動作:** マクロがファイル選択ダイアログを開く際、このパスが存在すれば初期位置として設定します。存在しない場合は、マクロファイル自身のフォルダを初期位置とします。<br>**備考:** ユーザーが頻繁に工程表ファイルを保存するフォルダを指定すると便利です。                                                                                                                                                                                          |
| `O43`                        | **A-3. 抽出結果出力シート名**                                            | **設定例:** `月次工程集約データ` (文字列)。<br>**詳細説明:** フィルター処理を通過した最終的な抽出データが書き出される、マクロ実行ファイル内のワークシート名を指定します。<br>**関連動作:** 指定された名前のシートが存在しない場合、マクロは「G. 出力シート設定」(`O811`-`O821`)に基づいてヘッダー行を含む新しいシートを自動生成します。既に存在する場合は、そのシートを使用します（既存データの扱いは`G-3`「出力データオプション」に従います）。<br>**備考:** このシート名はマクロ実行中に頻繁に参照されるため、正確に設定してください。                                                                                                                                  |
| `O44`                        | **A-4. 検索条件ログシート名**                                            | **設定例:** `実行履歴ログ` (文字列)。<br>**詳細説明:** マクロが実行された日時、その際に使用された主要なConfig設定値（特にフィルター条件など）、処理対象となったファイル数などを記録するためのログシート名を指定します。<br>**関連動作:** 指定された名前のシートが存在しない場合、マクロは簡易的なヘッダー行（例: "実行日時", "項目", "設定値", "備考"）を持つ新しいシートを自動生成します。<br>**備考:** マクロの実行履歴や適用された条件を後から確認するために重要なシートです。                                                                                                                                                                 |
| `O45`                        | **A-5. エラーログシート名**                                              | **設定例:** `エラー発生記録` (文字列)。<br>**詳細説明:** マクロ処理中に発生した全てのエラー（ファイルアクセス不可、データ型不整合、予期せぬ実行時エラーなど）の詳細情報を記録するためのログシート名を指定します。<br>**関連動作:** 指定された名前のシートが存在しない場合、マクロは簡易的なヘッダー行（例: "発生日時", "モジュール", "プロシージャ", "エラー番号", "エラー内容", "対処"など）を持つ新しいシートを自動生成します。<br>**備考:** トラブルシューティングの際に不可欠な情報源となります。                                                                                                                                       |
| `O46`                        | **A-6. 設定ファイルシート名 (自己参照用)**                               | **設定例:** `Config` (文字列)。<br>**詳細説明:** このConfigシート自身の名前をマクロが内部的に認識するために使用します。通常、このシート名と一致させます。<br>**関連動作:** マクロがConfigシートの値を読み書きする際に、この名前でシートオブジェクトを取得します。<br>**備考:** この値を変更する場合は、実際のシート名も一致させる必要があります。                                                                                                                                                                               |
| `O122`                       | **A-7. 工程パターンデータ取得方法**                                    | **設定例:** `TRUE` または `FALSE` (文字列、大文字小文字区別なし)。<br>**詳細説明:** 各工程表ファイルに適用する工程パターン情報（管内、分類、工程列数）を「Config」シートから取得する際の具体的な方法を制御します。<br>**関連動作:** <br> - **`TRUE`の場合:** マクロは`C-1`(`O126`)にパターン識別子を書き込んだ後、`Application.Calculate`を実行してExcelに「Config」シート上の関連数式（`J129:X(128+O114の値)`範囲など、これらは`Work`シートを参照している想定）を再計算させます。マクロは適切な待機処理（例: `DoEvents` + 短時間`Wait`、または特定のキーセルが計算完了状態になるまでの監視）の後、更新された数式結果を読み取ります。<br> - **`FALSE` (または`TRUE`以外の文字列) の場合:** マクロはVBAのロジック内で、`C-1`(`O126`、または`E-3`から直接取得したパターン識別子)、`C-2`(`I列`の工程キー）、および`C-8`(`O128:X128`のシート名ヘッダー）をキーとして使用し、**「Work」という名前のワークシート**を直接検索・参照して必要な情報を取得します。この場合、Excelの再計算は行いません。<br>**備考:** `Work`シートのデータ構造や数式の複雑さ、計算速度に応じてこのフラグを使い分けます。`FALSE`はVBAによる直接制御で安定性と速度が期待できますが、`Work`シートの構造変更にVBAコードの修正が必要になる場合があります。`TRUE`はExcel数式の柔軟性を活かせますが、計算時間と待機処理の確実性が課題となることがあります。 |
| **B. 工程表ファイル内 設定** |                                                                        |                                                                                                                                                                                                                                                                                                |
| `O66`-`O75`                  | **B-1. 工程表内 検索対象シート名リスト**                                 | **設定例:** `第1週`, `第2週`, `4月度`, `Sheet1` など (文字列、最大10個まで)。<br>**詳細説明:** 各処理対象の工程表ファイル内で、データ抽出を行うべきワークシートの名前をリスト形式で指定します。<br>**関連動作:** マクロはこのリストの上から順に、指定された名前のシートが存在すれば処理対象とします。リスト内で空白のセルは無視されます。<br>**備考:** 工程表ファイルのシート構成に合わせて正確に指定してください。                                                                                                                                |
| `O87`                        | **B-2. 工程表ヘッダー行数**                                                | **設定例:** `3` (正の整数)。<br>**詳細説明:** 工程表シートにおける、データ本体が実際に開始される行の**直前まで**に存在するヘッダー部分（タイトル行、注意書き行など、データ抽出対象外の行）の総数を指定します。<br>**関連動作:** 例えばこの値が`3`の場合、データ抽出は4行目から開始されると解釈されます。<br>**備考:** この値は、日付ごとのデータブロック開始行を計算する際の基準となります。                                                                                                                                |
| `O88`                        | **B-3. 工程表ヘッダー列数**                                                | **設定例:** `1` (正の整数)。<br>**詳細説明:** 工程表シートにおける、データ本体が実際に開始される列の**左端から数えて何列目まで**がヘッダー部分（またはデータ抽出対象外の列）であるかを指定します。例えば、A列のみが日付列などのヘッダーで、実際の工程データがB列から始まる場合、この値は`1`となります。<br>**関連動作:** この値は、各工程ブロックの基準列を計算する際の基準となります。<br>**備考:** 0は指定できません（最低でも1列はデータ開始前の領域があると想定）。                                                                                                |
| `O89`                        | **B-4. 1日のデータが占める行数**                                           | **設定例:** `8` (正の整数)。<br>**詳細説明:** 工程表シート内で、1日分のデータ（複数の工程ブロックや関連情報を含む）が、縦方向に合計で何行を占めているかを指定します。<br>**関連動作:** マクロは、最初の日のデータブロック開始行からこの行数分を1日分とみなし、次の日はその下に同様のブロックがあると想定して処理を進めます。<br>**備考:** この値と`B-2`「工程表ヘッダー行数」から、各日付のデータ開始行が計算されます。                                                                                                        |
| `O90`                        | **B-5. 1シート内の最大日数**                                               | **設定例:** `7` (正の整数)。<br>**詳細説明:** 工程表ファイル内の1枚のワークシートが、最大で何日分のデータを含んでいるかを指定します。例えば、週単位のシートであれば通常`7`（または`5`）となります。<br>**関連動作:** マクロは、各シート内でこの日数分、縦方向にデータ取得と処理を繰り返します。これを超えた範囲のデータは無視されます。<br>**備考:** 月によって日数が変動するシートの場合（例: 30日、31日）、その月の最大日数を設定します。                                                                                              |
| `O101`                       | **B-6. 「年」のセルアドレス (工程表シート内)**                               | **設定例:** `FR2`, `A1` など (文字列形式の有効なセルアドレス)。<br>**詳細説明:** 現在処理中の工程表シート内で、抽出データの基準となる「年」の情報が格納されているセルを指定します。<br>**関連動作:** マクロはこのセルから年の値（例: 2025）を読み取ります。<br>**備考:** 年情報がシート内に明記されていない場合は、別の手段（ファイル名から類推など、ただし本仕様ではセル指定を基本）を検討する必要があります。                                                                                                   |
| `O102`                       | **B-7. 「月」のセルアドレス (工程表シート内)**                               | **設定例:** `GB2`, `B1` など (文字列形式の有効なセルアドレス)。<br>**詳細説明:** 現在処理中の工程表シート内で、抽出データの基準となる「月」の情報が格納されているセルを指定します。<br>**関連動作:** マクロはこのセルから月の値（例: 4）を読み取ります。<br>**備考:** 月情報がシート内に明記されていない場合は、別の手段を検討する必要があります。                                                                                                             |
| `O103`                       | **B-8. 「日」の値がある列文字 (工程表シート内)**                            | **設定例:** `A`, `C` など (Excelの列を示すアルファベット文字列)。<br>**詳細説明:** 工程表シート内で、各日付の「日」の数値（例: 1, 2, ... 31）が記載されている列を指定します。<br>**関連動作:** マクロは、`B-9`「「日」の値の行オフセット」で計算される行の、この列から日の数値を取得します。<br>**備考:** 必ずしもA列である必要はありません。                                                                                                                        |
| `O104`                       | **B-9. 「日」の値の行オフセット**                                          | **設定例:** `3` (正の整数、1始まり)。<br>**詳細説明:** 各日付のデータブロック（`B-4`で定義された行数）の開始行から数えて、何行目に`B-8`で指定された列の「日」の数値が記載されているかを指定します。<br>**関連動作:** 例えば、ブロック開始が4行目でこの値が3なら、4+(3-1)=6行目の該当列から日を取得します。<br>**備考:** 工程表のレイアウトに合わせて正確に設定する必要があります。                                                                                                        |
| `O114`                       | **B-10. 1日の工程数**                                                     | **設定例:** `39` (正の整数)。<br>**詳細説明:** 工程表シート内で、1日あたりに横方向にいくつの独立した工程ブロック（作業詳細が記述される単位）が存在するかを指定します。<br>**関連動作:** マクロはこの数だけ、横方向に工程データの抽出と処理を繰り返します。<br>**備考:** この値は、後述の工程パターン定義（`C-3`～`C-9`）の行数と一致する必要があります。                                                                                                                     |
| **C. 工程パターン定義**       |                                                                        | (このセクションの設定値は、`A-7`「工程パターンデータ取得方法」フラグの値によって、マクロが値を読み込む方法が異なります)                                                                                                                                                                                                |
| `O126`                       | **C-1. 現在処理中ファイルに適用する工程パターン識別子**                       | **設定例:** `1`, `2`, `パターンA`, `2023年度標準` など (数値または文字列)。<br>**詳細説明:** 現在処理している工程表ファイルにどの工程パターン定義を適用するかを示す識別子です。<br>**関連動作:** マクロは、各ファイル処理の開始時に、「E-3. 各処理対象ファイル適用工程パターン」(`Q557`-`Q756`)から該当するパターン識別子を読み取り、この`O126`セルにVBAで書き込みます。その後、`A-7`フラグに応じて、Configシート上の数式再計算結果を読み取るか、VBAロジックで`Work`シートを直接参照してパターン詳細を取得します。<br>**備考:** ユーザーが手動でこのセルを編集する必要は通常ありません。マクロが自動制御します。 |
| `I129` - `I(128 + O114の値)` | **C-2. 工程キーリスト** (工程パターンデータ取得用)                 | **設定例:** `1`, `2`, `A-1`, `作業区分X` など (数値または文字列)。<br>**詳細説明:** `O114`で指定された「1日の工程数」と同じ行数だけ定義します。各行が1つの工程（横方向のブロック）に対応します。<br>**関連動作:** <br> - `A-7`が`FALSE`の場合: マクロが`Work`シートから工程パターン詳細（管内、分類、列数）を検索する際のキーの一つとして、`C-1`のパターン識別子および`C-8`のシート名ヘッダーと共に使用されます。<br> - `A-7`が`TRUE`の場合: この`I列`の値は、Configシートの`J列`以降の数式内で、`Work`シートの対応するデータを`VLOOKUP`や`INDEX/MATCH`で参照するためのキーとして使用されることを想定しています。<br>**備考:** 各工程を一意に識別するためのIDのような役割です。`Work`シートのデータ構造と整合している必要があります。 |
| `J129` - `J(128 + O114の値)` | **C-3. 管内1リスト** (`O126`のパターンに対応)                        | **設定例:** `大阪北`, `南拠点`, (空白も可) など (文字列)。<br>**詳細説明:** `O114`行数分。各行が`C-2`の工程キーに対応する工程の「管内1」情報を示します。<br>**関連動作:** <br> - マクロはこの列の値を読み取り、抽出データの「管内1」項目として使用します。<br> - また、この値は「D-3. 管内1フィルターリスト」(`O275`-`O294`)の比較対象となります。<br> - `A-7`が`TRUE`の場合はExcel数式の結果、`FALSE`の場合はVBAが`Work`シートから取得した結果がここに表示されることを想定（マクロは表示された値を読み取る）。<br>**備考:** 空白の場合は、抽出データの管内1も空白となります。                                                                            |
| `K129` - `K(128 + O114の値)` | **C-4. 管内2リスト** (`O126`のパターンに対応)                        | **設定例:** `野江`, `ABCセンター`, (空白も可) など (文字列)。<br>**詳細説明:** `O114`行数分。各行が`C-2`の工程キーに対応する工程の「管内2」情報を示します。<br>**関連動作:** マクロはこの列の値を読み取り、抽出データの「管内2」項目として使用します。また、「D-4. 管内2フィルターリスト」(`O305`-`O334`)の比較対象となります。取得ロジックは`C-3`と同様。<br>**備考:** 空白の場合は、抽出データの管内2も空白となります。                                                                             |
| `L129` - `L(128 + O114の値)` | **C-5. 分類1リスト** (`O126`のパターンに対応)                        | **設定例:** `制御`, `機械`, (空白も可) など (文字列)。<br>**詳細説明:** `O114`行数分。各行が`C-2`の工程キーに対応する工程の「分類1」情報を示します。<br>**関連動作:** マクロはこの列の値を読み取り、抽出データの「分類1」項目として使用します（出力ヘッダーに「分類」があれば）。また、「D-5. 分類1フィルター」(`O346`)の比較対象となります。取得ロジックは`C-3`と同様。<br>**備考:** オフセット定義(`F-1`,`F-2`)に「分類1抽出元」がある場合、そちらが優先されるか、あるいはこの`L列`の値がフィルター専用となるか、仕様の明確化が必要です（ここではこのL列の値がフィルター対象と仮定）。 |
| `M129` - `M(128 + O114の値)` | **C-6. 分類2リスト** (`O126`のパターンに対応)                        | **設定例:** `高圧`, `特高`, (空白も可) など (文字列)。<br>**詳細説明:** `O114`行数分。各行が`C-2`の工程キーに対応する工程の「分類2」情報を示します。<br>**関連動作:** 「D-6. 分類2フィルター」(`O367`)の比較対象。取得ロジックは`C-3`と同様。                                                                                                                                |
| `N129` - `N(128 + O114の値)` | **C-7. 分類3リスト** (`O126`のパターンに対応)                        | **設定例:** `100`, `A-1`, (空白も可) など (文字列または数値)。<br>**詳細説明:** `O114`行数分。各行が`C-2`の工程キーに対応する工程の「分類3」情報を示します。<br>**関連動作:** 「D-7. 分類3フィルター」(`O388`)の比較対象。取得ロジックは`C-3`と同様。                                                                                                                              |
| `O128`-`X128`               | **C-8. 工程列数定義用シート名ヘッダー**                              | **設定例:** `第1週`, `第2週`, `Sheet1`, ..., `第5週` (文字列、最大10個まで=X列まで)。<br>**詳細説明:** 工程表ファイル内で処理対象となるシート名（`B-1`「検索対象シート名リスト」で指定されるもの）と、このヘッダー文字列が一致する列の値を、そのシートにおける各工程の「工程列数」として使用します。<br>**関連動作:** マクロは、現在処理中の工程表シート名とこのヘッダー行の文字列を比較し、一致した列（`O`～`X`列のいずれか）の`129`行目以降の値を、そのシートでの工程列数として読み取ります。<br>**備考:** 工程表のシート名が可変である場合に対応するための重要な定義です。 |
| `O129`-`X(128 + O114の値)`  | **C-9. 工程パターン別 工程列数定義**                                 | **設定例:** `4`, `5`, `1` など (正の整数または0)。<br>**詳細説明:** `O114`行数分。各行が`C-2`の工程キーに対応する1つの工程を示し、各列(`O`～`X`)が`C-8`で定義されたシート名ヘッダーに対応します。セル内の数値が、その「シート」におけるその「工程」が使用する「列数」を表します。<br>**関連動作:** <br> - マクロは、現在処理中のシート名に合致する列（`C-8`で決定）から、現在の工程インデックスに対応する行の数値を読み取り、それを「作業員名」を抽出する際の列数上限（つまり最大作業員数、ただし全体の上限は10名）として使用します。<br> - 空白セルや数値以外の値は0列として扱われます。<br> - `A-7`が`TRUE`の場合はExcel数式の結果、`FALSE`の場合はVBAが`Work`シートから取得した結果がここに表示されることを想定（マクロは表示された値を読み取る）。<br>**備考:** これにより、同じ工程でもシートによって作業員の最大数が変動するような複雑な工程表に対応できます。 |
| **D. フィルター条件**       |                                                                        | (各フィルターは、対応する抽出データ項目と比較されます。リスト形式のフィルターは、リスト内のいずれかの条件に合致すればOKというOR検索が基本です。フィルターリストが空、またはフィルター条件セルが空の場合は、そのフィルターは適用されません。)                                                                                                                          |
| `O242`                       | **D-1. 作業員フィルター検索論理**                                        | **設定例:** `AND` または `OR` (文字列)。<br>**詳細説明:** `D-2`「作業員フィルターリスト」内の複数名をどのように判定するか指定します。<br>**関連動作:** `AND`の場合、リスト内の全ての作業員がその工程の抽出作業員に含まれている場合にのみ合致。`OR`の場合、リスト内のいずれか一人の作業員が含まれていれば合致。<br>**備考:** デフォルトは`OR`として扱うことを推奨（不正な文字列の場合など）。                                                                                                    |
| `O243`-`O262`                | **D-2. 作業員フィルターリスト**                                          | **設定例:** `山田太郎`, `佐藤花子` など (文字列、最大20名まで)。<br>**詳細説明:** ここに記載された作業員名に基づいてデータを絞り込みます。<br>**関連動作:** 空白セルは無視。抽出された作業員名と、このリスト内の各名前を**完全一致**（大文字・小文字は区別しない `vbTextCompare`）で比較します。論理は`D-1`に従います。<br>**備考:** 同姓同名に注意。                                                                                                                                 |
| `O275`-`O294`                | **D-3. 管内1フィルターリスト**                                           | **設定例:** `大阪北`, `南大阪` など (文字列、最大20項目まで)。<br>**詳細説明:** ここに記載された管内名に基づいてデータを絞り込みます。<br>**関連動作:** 空白セルは無視。抽出データ内の「管内1」（`C-3`で定義された値）と、このリスト内の各項目を**完全一致**（大文字・小文字を区別する `vbBinaryCompare`）で比較します。リスト内のいずれかに合致すればOK (OR検索)。                                                                                                 |
| `O305`-`O334`                | **D-4. 管内2フィルターリスト**                                           | **設定例:** `野江`, `小曽根` など (文字列、最大30項目まで)。<br>**詳細説明:** ここに記載された管内名に基づいてデータを絞り込みます。<br>**関連動作:** 空白セルは無視。抽出データ内の「管内2」（`C-4`で定義された値）と、このリスト内の各項目を**完全一致**（大文字・小文字を区別する `vbBinaryCompare`）で比較します。リスト内のいずれかに合致すればOK (OR検索)。                                                                                                 |
| `O346`                       | **D-5. 分類1フィルター**                                                 | **設定例:** `制御`, `変電 OR 保護` など (文字列、複数指定時はカンマ`,`または` OR `(スペースorスペース)区切り)。<br>**詳細説明:** ここに記載されたキーワードに基づいてデータを絞り込みます。<br>**関連動作:** カンマまたは" OR "で区切られた各キーワードと、抽出データ内の「分類1」（`C-5`で定義された値）を**部分一致**（大文字・小文字は区別しない `vbTextCompare`, `InStr`関数使用）で比較します。いずれかのキーワードに合致すればOK (OR検索)。空白のキーワードは無視。<br>**備考:**  `O122`が`TRUE`の場合、`L129`以降の数式結果と比較。`FALSE`の場合、VBAが`Work`シートから取得した分類1データと比較。 |
| `O367`                       | **D-6. 分類2フィルター**                                                 | **設定例:** `高圧`, `特高 AND 新設` など (文字列、複数指定時はカンマ`,`または` OR `区切り)。<br>**詳細説明:** `D-5`と同様のロジックで、抽出データ内の「分類2」（`C-6`で定義された値）と比較します。**部分一致**、OR検索。<br>**備考:** `O122`が`TRUE`の場合、`M129`以降の数式結果と比較。`FALSE`の場合、VBAが`Work`シートから取得した分類2データと比較。                                                                                             |
| `O388`                       | **D-7. 分類3フィルター**                                                 | **設定例:** `100`, `A-1, B-2` など (文字列、複数指定時はカンマ`,`または` OR `区切り)。<br>**詳細説明:** `D-5`と同様のロジックで、抽出データ内の「分類3」（`C-7`で定義された値）と比較します。**ただし、こちらは完全一致**（大文字・小文字は区別しない `vbTextCompare`）で比較。OR検索。<br>**備考:** `O122`が`TRUE`の場合、`N129`以降の数式結果と比較。`FALSE`の場合、VBAが`Work`シートから取得した分類3データと比較。                                                                      |
| `O409`-`O418`                | **D-8. 工事種類フィルターリスト**                                        | **設定例:** `自主`, `点検`, `自` など (文字列、最大10項目まで)。<br>**詳細説明:** ここに記載された工事種類キーワードに基づいてデータを絞り込みます。<br>**関連動作:** 空白セルは無視。抽出データ内の「工事種類」（オフセット定義`F-1`/`F-2`の"工事種類"項目で取得）と、このリスト内の各キーワードを**部分一致**（大文字・小文字は区別しない `vbTextCompare`）で比較します。リスト内のいずれかに合致すればOK (OR検索)。                                                                                             |
| `O431`-`O440`                | **D-9. 工番フィルターリスト**                                            | **設定例:** `X*`, `A-`, `*05`, `S12345` など (文字列、最大10項目まで)。<br>**詳細説明:** ここに記載された工番キーワードに基づいてデータを絞り込みます。<br>**関連動作:** 空白セルは無視。抽出データ内の「工番」（オフセット定義`F-1`/`F-2`の"工番"項目で取得）と、このリスト内の各キーワードを**部分一致**（大文字・小文字は区別しない `vbTextCompare`）で比較します。ワイルドカード文字（`*`, `?`）は通常の文字として扱います。リスト内のいずれかに合致すればOK (OR検索)。                                                                      |
| `O451`-`O470`                | **D-10. 作業種類フィルターリスト**                                       | **設定例:** `TrRy`, `TrPro`, `HTR` など (文字列、最大20項目まで)。<br>**詳細説明:** ここに記載された作業種類キーワードに基づいてデータを絞り込みます。<br>**関連動作:** 空白セルは無視。抽出データ内の「作業名1」または「作業名2」（オフセット定義`F-1`/`F-2`の"作業名1","作業名2"項目で取得）の**いずれか**と、このリスト内の各キーワードを**部分一致**（大文字・小文字は区別しない `vbTextCompare`）で比較します。リスト内のいずれかに合致すればOK (OR検索)。                                                                        |
| `O481`-`O490`                | **D-11. 担当の名前フィルターリスト**                                     | **設定例:** `鈴木一郎`, `田中`, `鈴` など (文字列、最大10項目まで)。<br>**詳細説明:** ここに記載された担当者名キーワードに基づいてデータを絞り込みます。<br>**関連動作:** 空白セルは無視。抽出データ内の「担当の名前」（オフセット定義`F-1`/`F-2`の"担当の名前"項目で取得）と、このリスト内の各キーワードを**部分一致**（大文字・小文字は区別しない `vbTextCompare`）で比較します。リスト内のいずれかに合致すればOK (OR検索)。                                                                                        |
| `O503`                       | **D-12. 人数フィルター**                                                 | **設定例:** `3` (数値、1項目のみ)。<br>**詳細説明:** 指定された人数と完全に一致するデータを抽出します。<br>**関連動作:** 空白の場合はこのフィルターは適用されません。抽出データ内の「人数」（オフセット定義`F-1`/`F-2`の"人数"項目で取得）と、このセルの値を数値として**完全一致**で比較します。                                                                                                                                  |
| `O514`                       | **D-13. 作業箇所の種類フィルター**                                       | **設定例:** `変電所`, `開閉所, 発電所` など (文字列、複数指定時はカンマ区切り)。<br>**詳細説明:** ここに記載された作業場所の種別キーワードに基づいてデータを絞り込みます。<br>**関連動作:** 空白は無視。抽出データ内の「変電所」（作業箇所名、オフセット定義`F-1`/`F-2`の"変電所"項目で取得）と、カンマで区切られた各キーワードを**部分一致**（大文字・小文字は区別しない `vbTextCompare`）で比較します。いずれかのキーワードに合致すればOK (OR検索)。                                                                           |
| `O525`-`O544`                | **D-14. 作業箇所フィルターリスト**                                       | **設定例:** `猪飼野`, `豊中SS` など (文字列、最大20項目まで)。<br>**詳細説明:** ここに記載された作業箇所名キーワードに基づいてデータを絞り込みます。<br>**関連動作:** 空白セルは無視。抽出データ内の「変電所」（作業箇所名、オフセット定義`F-1`/`F-2`の"変電所"項目で取得）と、このリスト内の各キーワードを**部分一致**（大文字・小文字は区別しない `vbTextCompare`）で比較します。リスト内のいずれかに合致すればOK (OR検索)。                                                                                   |
| **E. 処理対象ファイル定義**   |                                                                        |                                                                                                                                                                                                                                                                                                |
| `O557`-`O756`                | **E-1. (表示用) 選択ファイル名** (マクロ処理には直接使用しない)              | **設定例:** `2025.04 月間予定表.xlsx` ... (文字列、最大200件)。<br>**詳細説明:** この列はユーザーが参照するための表示用であり、マクロの動作には直接影響しません。<br>**備考:** `P列`および`Q列`と行を合わせて管理すると便利です。                                                                                                                                                             |
| `P557`-`P756`                | **E-2. 処理対象ファイル/フォルダパスリスト**                               | **設定例:** `C:\Koutei\202504_schedule.xlsx`, `D:\Shared\KouteiData\` など (文字列、最大200件)。<br>**詳細説明:** マクロが処理する工程表ファイルのフルパス、またはそれらのファイルが格納されているフォルダのパスを指定します。<br>**関連動作:** <br> - このリストに1つでも有効なパスが記載されていれば、それらが優先的に処理されます。<br> - フォルダパスが指定された場合、そのフォルダ直下にあるExcelファイル（`.xlsx`, `.xls`, `.xlsm`）のみが対象となります（サブフォルダは探索しません）。<br> - このリストが全て空欄、または有効なパスが1つもなかった場合、ファイル選択ダイアログが表示されます。<br> - ExcelのVLOOKUP関数等で他の場所からパス情報を参照している場合、マクロ実行前にそれらの数式が正しく計算結果を返している必要があります。<br>**備考:** 存在しないパスやアクセスできないパスはエラーログに記録され、スキップされます。 |
| `Q557`-`Q756`                | **E-3. 各処理対象ファイル適用工程パターン識別子**                          | **設定例:** `1`, `2`, `標準パターン2024`, `特別対応A` など (数値または文字列、最大200件)。<br>**詳細説明:** `P列`で指定された各ファイルパスに対して、どの工程パターン定義（`C`セクションで詳述）を適用するかを指定します。<br>**関連動作:** マクロは、`P列`のファイルを処理する際に、同じ行の`Q列`の値を読み取り、それを`C-1`(`O126`)セルに転記します。この`O126`の値が、`A-7`フラグに応じてConfigシート上の数式計算のトリガーとなるか、VBAによる`Work`シート検索のキーとなります。<br> - 空白の場合の扱いは、「仕様書」または「期待する動作」で明確化が必要です（例: デフォルトでパターン"1"を適用、またはエラーとしてスキップなど。ここでは**パターン"1"を適用することを推奨**）。<br>**備考:** ExcelのVLOOKUP関数等でファイル名から適切なパターン識別子を自動入力する運用が想定されます。 |
| **F. 抽出データオフセット定義** |                                                                        | (各工程ブロック内の基準セル（通常は左上）からの相対位置を `行数,列数` 形式で指定します。0行0列は基準セル自身を指します。)                                                                                                                                                                                                    |
| `N778`-`N792`                | **F-1. オフセット項目名リスト** (最大15項目まで)                             | **設定例:** `工番`, `変電所`, `作業名1`, `作業名2`, `担当の名前`, `工事種類`, `人数`, `作業員`, `旧その他`, `終了時間`, `分類1抽出元` など (文字列)。<br>**詳細説明:** 工程表から抽出したいデータ項目の名前をリスト形式で定義します。<br>**関連動作:** マクロはこのリストを上から順に参照し、対応する`O列`のオフセット値を使ってデータを抽出します。この項目名は、出力シートのヘッダーやフィルター処理時の内部的なデータ識別にも利用される可能性があります。<br>**備考:** 「作業員」という項目名は、作業員1のオフセット定義として特別扱いされます。 |
| `O778`-`O792`                | **F-2. オフセット値リスト** (`行,列` 形式)                                 | **設定例:** `0,0`, `1,0`, `6,0` など (文字列)。<br>**詳細説明:** `N列`で定義された各項目名に対応する、工程ブロック基準セルからのオフセット値を `行数,列数` の形式で指定します。<br>**関連動作:** <br> - マクロはこのオフセット値を使って、`GetValueFromOffset`のような内部関数で実際のセルの値を取得します。<br> - 「作業員」という項目名に対するオフセットは、作業員1のオフセットを指します。作業員2以降は、マクロがこの列オフセットに自動的に+1, +2...と加算して抽出します。実際に抽出する作業員の最大数は、その工程に適用される「工程列数」（`C-9`で定義、最大10名）によって制御されます。<br> - オフセット値が空欄、または `行,列` の書式でない場合は、その項目の抽出はスキップされ、エラーログに記録されます。<br>**備考:** オフセットは0始まりではなく、実際のExcelの行・列の増減値です（例: 基準セルと同じなら`0,0`、1行下なら`1,0`、1列右なら`0,1`）。 |
| **G. 出力シート設定**       |                                                                        |                                                                                                                                                                                                                                                                                                |
| `O811`                       | **G-1. 出力シートヘッダー行数**                                            | **設定例:** `1` から `10` の範囲の整数。<br>**詳細説明:** `A-3`で指定された「抽出結果出力シート名」のシートに作成（または既にあれば使用）するヘッダーの行数を指定します。<br>**関連動作:** マクロは、この行数分、`G-2`「出力シートヘッダー内容」からヘッダー文字列を読み取り、出力シートの1行目から順に書き込みます。                                                                                                                                                            |
| `O812`-`O821`                | **G-2. 出力シートヘッダー内容**                                            | **設定例:** 1行目: `日付	管内1	管内2	工番	変電所	作業名1	作業名2	担当	分類	人数	作業者1	作業者2	作業者3	作業者4	作業者5	作業者6	作業者7	作業者8	作業者9	作業者10`<br> (各セルに1行分のヘッダー文字列を入力。文字列内でタブ文字(`vbTab`または`Chr(9)`)を使用すると、Excelが自動的に複数列に展開します。)<br>**詳細説明:** `G-1`で指定された行数分のヘッダー文字列を、1行につき1セルで定義します。<br>**関連動作:** マクロは、各セルの文字列をタブで分割し、出力シートの対応する行の各列にヘッダーとして設定します。<br>**備考:** **作業員名は最大10名分**の列ヘッダーを準備する想定です。実際の抽出データとヘッダー列が一致するように注意してください。 |
| `O1124`                      | **G-3. 出力データオプション**                                              | **設定例:** `リセット` または `引継ぎ` (文字列、大文字小文字区別なし)。<br>**詳細説明:** マクロ実行時の出力シートの既存データの扱いを指定します。<br>**関連動作:** <br> - `リセット`: マクロ実行開始時に、出力シートの既存データ（ヘッダー行は除く）を全てクリアしてから、新しい抽出結果を書き込みます。<br> - `引継ぎ`: 既存データの末尾に、新しい抽出結果を追記します。<br>**備考:** デフォルトまたは不正な文字列の場合は「リセット」として動作することを推奨。                                                                                                          |
| `O1126`                      | **G-4. 非表示方式**                                                        | **設定例:** `xlSheetHidden` または `xlSheetVeryHidden` (文字列)。<br>**詳細説明:** `G-5`で指定されたシートをマクロ終了時に非表示にする際の方式を指定します。<br>**関連動作:** <br> - `xlSheetHidden`: 通常の非表示（ユーザーが手動で再表示可能）。<br> - `xlSheetVeryHidden`: 強力な非表示（VBEからのみ再表示可能）。<br>**備考:** 不正な文字列の場合は、デフォルトで`xlSheetHidden`として動作することを推奨。                                                                                                         |
| `O1127`-`O1146`              | **G-5. マクロ実行後非表示シートリスト**                                    | **設定例:** `Config (1)`, `Work`, `旧データシート` など (文字列、最大20シートまで)。<br>**詳細説明:** マクロ実行完了後に非表示にしたいシートの名前をリスト形式で指定します。<br>**関連動作:** 空白セルは無視。ここに記載された名前と完全に一致するシートを、`G-4`で指定された方式で非表示にします。ただし、`A-3`で指定された「抽出結果出力シート名」のシートは、このリストに含まれていても非表示にしません。存在しないシート名が指定されている場合はエラーログに記録し、無視します。<br>**備考:** `Config`シート自身を非表示にする場合は注意が必要です。                         |
---
1.  **`O122`が`TRUE`の場合:**
    *   ファイル処理ループの開始時（または各ファイル処理前）に、`P列`のファイルパスに対応する`Q列`のパターン文字列を`O126`セルにVBAで書き込む。
    *   `Application.Calculate`を実行する。
    *   （オプション）計算完了を待つための短い`DoEvents`または`Application.Wait`を挟む（数秒程度）。または、特定のキーセル（例：`J129`など、数式の結果が入る最初のセル）がエラー値でなくなるまで待つ、などの堅牢な待機処理。
    *   更新された`J129:X(128+工程数)`の値をVBAで読み取り、内部変数（構造体や配列）に格納して使用する。
2.  **`O122`が`FALSE`の場合:**
    *   `O126`セルへの書き込みや`Application.Calculate`は行わない。
    *   `P列`のファイルパスに対応する`Q列`のパターン文字列をVBA内で取得する。
    *   そのパターン文字列、`I列`の工程キーリスト、`128行目`のシート名ヘッダーを使用して、VBAのロジックで`Work`シートを直接検索・参照し、必要な管内情報、分類情報、および該当シートの工程列数を取得して内部変数に格納する。
