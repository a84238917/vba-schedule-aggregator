このステップは、マクロの柔軟性を飛躍的に高める非常に重要な部分です。ファイルごとに異なる工程パターン情報を正しく読み込み、それをデータ抽出ロジックに反映させることを目指します。`Config`シートの `O122` フラグによる分岐処理の完全な実装が核心となります。

---

## プロンプト (AI: Jules向け) - ステップ7: 工程パターン切り替え機能の実装

**依頼プロジェクト名:** VBA Schedule Aggregator (工程表データ集約マクロ) - 再構築 (ステップ7)

**現在の開発ステップ:** 【ステップ7】工程パターン切り替え機能の実装

**このステップの目的:**
マクロが、**処理対象の各工程表ファイルに対して、それぞれに指定された「工程パターン」を動的に適用し、異なるデータ構造（特に各工程が使用する列数、および関連する管内・分類情報）に柔軟に対応できる完全な機能**を実装します。
この実装の核心は、「Config」シートの `O122`「工程パターンデータ取得方法」フラグの値に基づき、パターンデータの取得ロジックを正確に分岐させることです。これにより、ユーザーはExcel数式の利便性を取るか、VBAによる直接処理の安定性を取るかを選択できるようになります。

**参照必須ドキュメント:**
1.  `docs/00_Project_Overview.md` (工程パターン対応の重要性)
2.  `docs/01_System_Instructions_for_AI.md` (特に、原則1「設定駆動」の`O122`分岐、原則2「可読性」、原則3「堅牢性」)
3.  `docs/03_Functional_Specification.md` (セクション3.4「工程パターン適応機能」、3.6.2「工程パターン適用準備」)
4.  `docs/04_Config_Sheet_Definition.md` (特に、**A-7 (`O122`)**、**C-1 (`O126`)**、**C-2 (`I列`)**、**C-3～C-7 (`J～N列`)**、**C-8 (`O128:X128`)**、**C-9 (`O129:X(128+O114の値)`)** の各定義と関連動作)
5.  `docs/05_Expected_Behavior.md` (セクション6-2「工程パターン情報の決定と適用」の完全な動作フロー)
6.  `docs/07_Naming_Conventions_and_Glossary.md` (関連する変数名・型名の規約)

**前提条件:**
*   「【ステップ1】～【ステップ6】」で作成・更新された `M00`～`M06` の各モジュールが存在すること。
*   `M02_ConfigReader` で、ConfigのA, B, C, E, F, Gセクションの関連項目が読み込める状態であること。
*   `M05_FileProcessor` で、処理対象ファイルパスとそれに対応する「適用工程パターン識別子」のペアリストが正しく生成され、`M01_MainControl` に渡されること。
*   `M06_DataExtractor` の `ExtractDataFromFile` プロシージャが、引数として「適用工程パターン識別子」を受け取れるようにシグネチャが変更されていること。

**あなたのタスク:**
主に `M06_DataExtractor` モジュール内の `ExtractDataFromFile` プロシージャを大幅に拡充し、`M02_ConfigReader` モジュールを必要に応じて調整するVBAコードを生成してください。

**1. `M06_DataExtractor` モジュール (大幅拡充):**

*   **`Public Function ExtractDataFromFile(...) As Boolean` プロシージャの工程パターン適用ロジックの完全実装:**
    *   プロシージャの冒頭（ファイルオープン後、シート処理ループの前）で、引数として渡された `applyProcessPatternId` （現在のファイルに適用すべき工程パターン識別子）を処理します。
    *   **`applyProcessPatternId` を `Config`シートの`O126`セルにVBAで書き込みます。**
    *   **`g_configSettings.UseExcelFormulasForPatternData` (`Config O122`の値) に基づく分岐処理:**
        *   **`TRUE` (Excel数式再計算待ち) の場合:**
            1.  `Application.Calculate` を実行し、Excelブック全体の（特にConfigシート上の）再計算を強制します。
            2.  **堅牢な計算完了待機処理を実装:**
                *   `DoEvents` をループ内で定期的に呼び出します。
                *   Configシート上のキーとなる数式セル（例: `J129`、または`O129`など、パターン変更で確実に値が変わる最初のセル）が、計算中を示すエラー値 (`#N/A`, `#VALUE!`, `#CALC!`, `#GETTING_DATA` など、`IsError()`で判定可能）でなくなるまで、または期待されるデータ型（例: `IsNumeric` や `Not IsEmpty`）になるまでループで監視します。
                *   無限ループを避けるため、適切なタイムアウト処理（例: 30秒～60秒程度、Configで設定可能にしても良い）を実装し、タイムアウトした場合はエラーログに「Configシートの再計算がタイムアウトしました」と記録し、このファイルの処理を中断（`ExtractDataFromFile = False` として終了）するか、デフォルトパターンでの処理を試みます。
            3.  再計算完了後、「Configシート定義」の `C-3`～`C-7` (`J列`～`N列`) から、`g_configSettings.ProcessesPerDay` 行数分の「管内1」「管内2」「分類1」「分類2」「分類3」のデータを読み取り、VBAの内部変数（例: `currentFilePatternDetails() As tProcessDetail` または各項目ごとの配列）に格納します。
            4.  再計算完了後、「Configシート定義」の `C-9` (`O列`～`X列`) から、`g_configSettings.ProcessesPerDay` 行数分の「工程列数」データを読み取り、VBAの内部変数（例: `activeProcessColCounts(sheetNameIndex, processIndex) As Long` のような2次元配列、またはシート名ごとの1次元配列を保持するコレクション/ディクショナリ）に格納します。この際、`C-8` (`O128:X128`) のシート名ヘッダーと、現在処理対象の工程表シート名（`g_configSettings.TargetSheetNames`）を照合し、正しい列からデータを取得するようにします。
        *   **`FALSE` (VBAによる`Work`シート直接参照) の場合:**
            1.  `Config`シートの`O126`セルに書き込まれた（または引数で直接渡された） `applyProcessPatternId`、「Config」`I列`の「工程キーリスト」(`g_configSettings.ProcessDetails(i).SomeKeyMember`のような形ではなく、`I列`の値を直接配列として読み込んでおく必要があるかもしれません。`Config`読み込み時に`I列`の値を`g_configSettings.ProcessKeyList() As String`のようなメンバーに格納することを検討してください)、および「Config」`C-8` (`O128:X128`) の「工程列数定義用シート名ヘッダー」を検索キーとして使用します。
            2.  「Work」という名前のワークシート（存在確認が必要な場合は`M03_SheetManager`で対応済みと仮定、またはここで確認）を開くか参照します。
            3.  VBAのロジック（`For`ループ、`If`条件、必要であれば`Find`メソッドなど）を用いて、「Work」シート内を検索し、上記のキーに合致するレコードを探します。
            4.  合致したレコードから、「管内1」「管内2」「分類1」「分類2」「分類3」のデータ、および各シート名ヘッダーに対応する「工程列数」のデータを取得し、上記`TRUE`の場合と同様のVBA内部変数に格納します。
            5.  **エラー処理:** 「Work」シートに該当するパターン識別子や工程キーのデータが見つからない場合、エラーログに詳細を記録し、このファイルの処理を中断するか、デフォルトパターンでの処理を試みます。
    *   **取得したパターンデータの利用:**
        *   以降のシート処理ループ、日処理ループ、工程処理ループ内で、上記で内部変数に格納した「管内1/2」「分類1/2/3」「工程列数」の情報を参照して使用します。
        *   特に、工程処理ループ内の「作業員名」の抽出ロジック（ステップ5で実装済み）では、ここで取得した `currentProcessActualNumCols`（現在のシート・現在の工程に対応する列数）を正しく作業員数の上限として使用してください。
    *   エラーハンドリングを各所に適切に配置し、ログ出力を行ってください。

**2. `M02_ConfigReader` モジュール (調整):**

*   **`LoadConfiguration` プロシージャ内の調整:**
    *   `tConfigSettings` 型に、`I列`の「工程キーリスト」を格納するための新しい動的配列メンバー（例: `ProcessKeyList() As String`）を追加し、`LoadConfiguration`内で`I129`行目から`g_configSettings.ProcessesPerDay`行数分の値を読み込む処理を追加してください。これは、`O122`が`FALSE`の場合に`Work`シートを検索する際のキーとして使用します。
    *   `g_configSettings.ProcessDetails()` 配列は、`J列`から`N列`の管内・分類情報を格納するために引き続き使用します（`O122`が`TRUE`の場合は数式結果を、`FALSE`の場合は`Work`シートからの取得結果をここに格納する想定で、`M06`側でこの配列に値をセットします）。
    *   `g_configSettings.ProcessPatternColNumbers()` 配列は、`O列`から`X列`の工程列数を格納するために引き続き使用します（同様に`M06`側で値をセット）。

**生成コードに関する期待:**
*   `M06_DataExtractor.ExtractDataFromFile` が、引数で渡された「適用工程パターン識別子」に基づき、`Config O122` フラグに従って、正しい分岐処理（Excel再計算待ち or VBAによるWorkシート直接参照）を実行できること。
*   どちらの分岐でも、最終的にそのファイル・そのシート・その工程に対応する「管内1/2」「分類1/2/3」「工程列数」の情報がVBA内部変数に正しく取得されること。
*   取得された「工程列数」が、作業員名の抽出上限として正確に機能すること。
*   パターン情報の取得に失敗した場合（例: `Work`シートに該当データなし、Config数式エラータイムアウト）、適切なエラーログが記録され、処理が安全に継続（デフォルトパターン適用またはファイルスキップ）されること。
*   既存のデータ抽出ロジック（年月日時取得、オフセットに基づく項目抽出、空白行判定、一覧シートへの書き出しなど）は、この新しいパターン情報取得ロジックと正しく連携して動作すること。
*   「System Instructions」のコーディング規約（特にコメントと命名、エラーハンドリング）を遵守すること。

**成果物:**
上記の指示に基づき大幅に拡充された `M06_DataExtractor` モジュール、および必要な調整が加えられた `M02_ConfigReader` モジュールのVBAコード。

---

このステップは本マクロの柔軟性を左右する非常に重要な部分です。AIには、`O122`フラグによる分岐処理、Excel再計算の待機処理、`Work`シートからのデータ検索ロジックなど、複雑な要件を正確に理解し、堅牢に実装することが求められます。